<!DOCTYPE html>
<html>
<head>
    <title>Slides Examples (External)</title>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@14.0.1/Arrow.es2015.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #$div_id {
            width: 100%;
            height: 600px;
        }
    </style>
        <style>
        .textblock-content {
            padding: 20px;
            margin: 10px 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .textblock-content h1 {
            font-size: 2em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .textblock-content h2 {
            font-size: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .textblock-content h3 {
            font-size: 1.25em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .textblock-content p {
            margin: 0.5em 0;
        }

        .textblock-content ul, .textblock-content ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }

        .textblock-content code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .textblock-content pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .textblock-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .textblock-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1em;
            margin-left: 0;
            color: #666;
        }

        .textblock-content a {
            color: #0066cc;
            text-decoration: none;
        }

        .textblock-content a:hover {
            text-decoration: underline;
        }

        .textblock-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        .textblock-content th, .textblock-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .textblock-content th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
    </style>


    <!-- external libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/d3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/c3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/export_renderers.min.js"></script>

    <!-- Prism.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    
</head>

<body>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<script type="module">
// Import parquet-wasm for Parquet file support
import * as parquet from 'https://unpkg.com/parquet-wasm@0.6.1/esm/parquet_wasm.js';

// Initialize parquet-wasm
await parquet.default();

// Make parquet available globally for loadDataset
window.parquetWasm = parquet;
window.parquetReady = true;
console.log('Parquet-wasm library loaded successfully');
</script>

<script>
// Helper function to wait for parquet-wasm to be loaded
function waitForParquet() {
    return new Promise(function(resolve) {
        if (window.parquetReady) {
            resolve();
            return;
        }
        var checkInterval = setInterval(function() {
            if (window.parquetReady) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 50);
    });
}

// Centralized data loading function
// This function parses data from embedded or external sources and returns a Promise
// Supports CSV (embedded/external), JSON (embedded/external), and Parquet (external) formats
// Usage: loadDataset('dataLabel').then(function(data) { /* use data */ });
function loadDataset(dataLabel) {
    return new Promise(function(resolve, reject) {
        var dataElement = document.getElementById(dataLabel);
        if (!dataElement) {
            reject(new Error('Data element not found: ' + dataLabel));
            return;
        }

        var format = dataElement.getAttribute('data-format') || 'csv_embedded';
        var dataSrc = dataElement.getAttribute('data-src');

        // Handle external JSON files
        if (format === 'json_external' && dataSrc) {
            fetch(dataSrc)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(function(data) {
                    resolve(data);
                })
                .catch(function(error) {
                    console.error('Error loading external JSON:', error);
                    reject(error);
                });
            return;
        }

        // Handle external Parquet files
        if (format === 'parquet' && dataSrc) {
            // Wait for parquet-wasm to be loaded first
            waitForParquet()
                .then(function() {
                    return fetch(dataSrc);
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.arrayBuffer();
                })
                .then(function(arrayBuffer) {
                    // Use parquet-wasm to read the file
                    var uint8Array = new Uint8Array(arrayBuffer);

                    // readParquet returns an Arrow Table
                    var wasmTable = window.parquetWasm.readParquet(uint8Array);

                    // Convert to Arrow IPC stream
                    var ipcStream = wasmTable.intoIPCStream();

                    // Use Apache Arrow JS to read the IPC stream
                    var arrowTable = window.Arrow.tableFromIPC(ipcStream);

                    // Convert Arrow Table to array of JavaScript objects
                    var data = [];
                    for (var i = 0; i < arrowTable.numRows; i++) {
                        var row = {};
                        arrowTable.schema.fields.forEach(function(field) {
                            var column = arrowTable.getChild(field.name);
                            var value = column.get(i);

                            // Convert BigInt to Number (Arrow returns BigInt for Int64)
                            if (typeof value === 'bigint') {
                                value = Number(value);
                            }

                            row[field.name] = value;
                        });
                        data.push(row);
                    }

                    resolve(data);
                })
                .catch(function(error) {
                    console.error('Error loading external Parquet:', error);
                    reject(error);
                });
            return;
        }

        // Handle external CSV files
        if (format === 'csv_external' && dataSrc) {
            fetch(dataSrc)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.text();
                })
                .then(function(csvText) {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            // Check for fatal errors only (not warnings)
                            var fatalErrors = results.errors.filter(function(err) {
                                return err.type !== 'Delimiter';
                            });

                            if (fatalErrors.length > 0) {
                                console.error('CSV parsing errors:', fatalErrors);
                                reject(fatalErrors);
                            } else if (results.data && results.data.length > 0) {
                                resolve(results.data);
                            } else {
                                reject(new Error('No data parsed from CSV'));
                            }
                        },
                        error: function(error) {
                            console.error('CSV parsing error:', error);
                            reject(error);
                        }
                    });
                })
                .catch(function(error) {
                    console.error('Error loading external CSV:', error);
                    reject(error);
                });
            return;
        }

        // Handle embedded data
        var dataText = dataElement.textContent.trim();

        if (format === 'json_embedded') {
            // Parse JSON data
            try {
                var data = JSON.parse(dataText);
                resolve(data);
            } catch (error) {
                console.error('JSON parsing error:', error);
                reject(error);
            }
        } else if (format === 'csv_embedded') {
            // Parse CSV data using PapaParse
            Papa.parse(dataText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Check for fatal errors only (not warnings)
                    // PapaParse includes non-fatal warnings in errors array
                    var fatalErrors = results.errors.filter(function(err) {
                        // Filter out delimiter detection warnings - these aren't fatal
                        // (common for single-column CSVs)
                        return err.type !== 'Delimiter';
                    });

                    if (fatalErrors.length > 0) {
                        console.error('CSV parsing errors:', fatalErrors);
                        reject(fatalErrors);
                    } else if (results.data && results.data.length > 0) {
                        resolve(results.data);
                    } else {
                        reject(new Error('No data parsed from CSV'));
                    }
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    reject(error);
                }
            });
        } else {
            reject(new Error('Unsupported data format: ' + format));
        }
    });
}

$(function(){

(function() {
    const GROUP_NAMES = ['Region', 'Quarter'];
    const SLIDE_NUMBERS = [1, 2];
    const FILE_MAPPING = {
    'West,Q3,1': 'img_slide_West_Q3_1_svg',
    'East,Q4,1': 'img_slide_East_Q4_1_svg',
    'West,Q3,2': 'img_slide_West_Q3_2_svg',
    'West,Q4,1': 'img_slide_West_Q4_1_svg',
    'West,Q4,2': 'img_slide_West_Q4_2_svg',
    'East,Q3,2': 'img_slide_East_Q3_2_svg',
    'East,Q3,1': 'img_slide_East_Q3_1_svg',
    'East,Q4,2': 'img_slide_East_Q4_2_svg'
    };

    let currentSlideIndex = 0;
    let isPlaying = false;
    let playInterval = null;
    let slideDelay = 1000.0;  // milliseconds

    function updateSlide_external_slides() {
        // Get current filter values
        const filterValues = [];
        for (let groupName of GROUP_NAMES) {
            const select = document.getElementById(groupName + '_select_external_slides');
            if (select) {
                filterValues.push(select.value);
            }
        }

        // Get current slide number
        const slideNum = SLIDE_NUMBERS[currentSlideIndex];

        // Build lookup key
        const key = [...filterValues, slideNum].join(',');
        const imageId = FILE_MAPPING[key];

        // Hide all images
        const allImages = document.querySelectorAll('.slide-image-external_slides');
        allImages.forEach(img => img.style.display = 'none');

        // Show selected image
        if (imageId) {
            const selectedImg = document.getElementById(imageId);
            if (selectedImg) {
                selectedImg.style.display = 'block';
            }
        }

        // Update slide counter
        const counter = document.getElementById('slide-counter-external_slides');
        if (counter) {
            counter.textContent = `Slide ${currentSlideIndex + 1} / ${SLIDE_NUMBERS.length}`;
        }
    }

    function previousSlide_external_slides() {
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            updateSlide_external_slides();
        }
    }

    function nextSlide_external_slides() {
        if (currentSlideIndex < SLIDE_NUMBERS.length - 1) {
            currentSlideIndex++;
            updateSlide_external_slides();
        }
    }

    function togglePlay_external_slides() {
        isPlaying = !isPlaying;
        const btn = document.getElementById('play-btn-external_slides');

        if (isPlaying) {
            btn.textContent = '⏸ Pause';
            playInterval = setInterval(() => {
                if (currentSlideIndex < SLIDE_NUMBERS.length - 1) {
                    nextSlide_external_slides();
                } else {
                    // Loop back to start
                    currentSlideIndex = 0;
                    updateSlide_external_slides();
                }
            }, slideDelay);
        } else {
            btn.textContent = '▶ Play';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }
    }

    function updateDelay_external_slides() {
        const slider = document.getElementById('delay-slider-external_slides');
        const label = document.getElementById('delay-label-external_slides');
        // Convert slider value (0-100) to delay using log scale (0.05s to 5s)
        const sliderVal = parseFloat(slider.value);
        const delaySeconds = 0.05 * Math.pow(10, sliderVal / 50);
        slideDelay = delaySeconds * 1000;
        label.textContent = delaySeconds.toFixed(2) + 's';

        // Restart interval if playing
        if (isPlaying && playInterval) {
            clearInterval(playInterval);
            playInterval = setInterval(() => {
                if (currentSlideIndex < SLIDE_NUMBERS.length - 1) {
                    nextSlide_external_slides();
                } else {
                    currentSlideIndex = 0;
                    updateSlide_external_slides();
                }
            }, slideDelay);
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
            if (e.key === 'ArrowLeft') {
                previousSlide_external_slides();
            } else if (e.key === 'ArrowRight') {
                nextSlide_external_slides();
            } else if (e.key === ' ') {
                e.preventDefault();
                togglePlay_external_slides();
            }
        }
    });

    // Initialize
    updateSlide_external_slides();
    

    // Expose functions globally
    window.previousSlide_external_slides = previousSlide_external_slides;
    window.nextSlide_external_slides = nextSlide_external_slides;
    window.togglePlay_external_slides = togglePlay_external_slides;
    window.updateSlide_external_slides = updateSlide_external_slides;
    window.updateDelay_external_slides = updateDelay_external_slides;
})();


});
</script>

<!-- DATASETS -->

<script type="text/plain" id="revenue_data" data-format="parquet" data-src="data/revenue_data.parquet"></script>

<!-- ACTUAL CONTENT -->

<h1></h1>
<p></p>

    <div class="textblock-content">
        <h1>Slides Examples</h1>
<p>This page demonstrates the interactive Slides chart type in JSPlots.</p>
<ul>
    <li><strong>File-based slides:</strong> Load images from a directory with automatic filtering</li>
    <li><strong>Function-generated slides:</strong> Create slides dynamically from data using a custom function</li>
    <li><strong>Interactive controls:</strong> Play/pause, navigation, adjustable speed</li>
    <li><strong>Filtering:</strong> Filter slides by group dimensions</li>
</ul>

    </div>
<br>
<hr>
<br>
    <div class="textblock-content">
        <h2>Example 3: External Storage of slides</h2>
<p>This example demonstrates using Slides with external storage.</p>
<p>When using external dataformats (parquet, csv_external, json_external), slide images are stored in a <code>slides/</code> subdirectory rather than being embedded in the HTML file.</p>
<ul>
    <li>Creates a portable project directory structure</li>
    <li>Slide images stored in <code>slides/</code> subdirectory</li>
    <li>Data stored in <code>data/</code> subdirectory (if applicable)</li>
    <li>Useful for large slide sets or when you need external file access</li>
</ul>

    </div>
<br>
<hr>
<br>
<style>
    .slides-container-external_slides {
        padding: 20px;
        margin: 10px 0;
    }

    .slides-image-area-external_slides {
        text-align: center;
        background-color: #f5f5f5;
        padding: 20px;
        min-height: 400px;
        margin: 20px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .slide-image-external_slides {
        max-width: 100%;
        max-height: 600px;
        height: auto;
        display: none;
    }

    .slides-controls-external_slides {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 15px;
        background-color: #f0f0f0;
        border-radius: 5px;
        flex-wrap: wrap;
    }

    .slides-controls-external_slides button {
        padding: 8px 16px;
        font-size: 14px;
        border: 1px solid #ccc;
        background-color: white;
        cursor: pointer;
        border-radius: 4px;
    }

    .slides-controls-external_slides button:hover {
        background-color: #e8e8e8;
    }

    .slides-controls-external_slides button:active {
        background-color: #d0d0d0;
    }

    .delay-control-external_slides {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .delay-control-external_slides input[type="range"] {
        width: 150px;
    }
</style>

<div class="slides-container-external_slides">
    <h2>Revenue Analysis (External Storage)</h2>
    <p>Slides stored externally in slides/ directory. Useful for large datasets or when images need to be accessible as separate files.</p>

    <!-- Filters -->
    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <h4 style="margin-top: 0;">Filters</h4>
                    <div style="margin: 10px;">
            <label for="Region_select_external_slides">Region: </label>
            <select id="Region_select_external_slides" onchange="updateSlide_external_slides()">
                <option value="East" selected>East</option>
                <option value="West">West</option>
            </select>
        </div>
                <div style="margin: 10px;">
            <label for="Quarter_select_external_slides">Quarter: </label>
            <select id="Quarter_select_external_slides" onchange="updateSlide_external_slides()">
                <option value="Q3" selected>Q3</option>
                <option value="Q4">Q4</option>
            </select>
        </div>
        
        </div>

    <!-- Slide Display Area -->
    <div class="slides-image-area-external_slides">
        <!-- Images will be inserted here by HTML generation -->
        <img class="slide-image-external_slides" id="img_slide_West_Q3_1_svg" src="slides/img_slide_West_Q3_1_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_East_Q4_1_svg" src="slides/img_slide_East_Q4_1_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_West_Q3_2_svg" src="slides/img_slide_West_Q3_2_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_West_Q4_1_svg" src="slides/img_slide_West_Q4_1_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_West_Q4_2_svg" src="slides/img_slide_West_Q4_2_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_East_Q3_2_svg" src="slides/img_slide_East_Q3_2_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_East_Q3_1_svg" src="slides/img_slide_East_Q3_1_svg.svg" alt="Slide" />
<img class="slide-image-external_slides" id="img_slide_East_Q4_2_svg" src="slides/img_slide_East_Q4_2_svg.svg" alt="Slide" />

    </div>

    <!-- Controls -->
    <div class="slides-controls-external_slides">
        <button onclick="previousSlide_external_slides()">◀ Previous</button>
        <button id="play-btn-external_slides" onclick="togglePlay_external_slides()">▶ Play</button>
        <button onclick="nextSlide_external_slides()">Next ▶</button>
        <span id="slide-counter-external_slides" style="font-weight: bold; min-width: 100px;">Slide 1 / 2</span>
        <div class="delay-control-external_slides">
            <label for="delay-slider-external_slides">Delay:</label>
            <input type="range" id="delay-slider-external_slides"
                   min="0" max="100" step="1" value="65"
                   oninput="updateDelay_external_slides()">
            <span id="delay-label-external_slides">1.0s</span>
        </div>
    </div>

    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
        <strong>Keyboard shortcuts:</strong> ← Previous, → Next, Space Play/Pause
    </p>
</div>
<br>
<hr>
<br>
    <div class="textblock-content">
        <h2>Summary</h2>
<p>This page demonstrated four ways to use the Slides chart type:</p>
<ul>
    <li><strong>Method 1 - From Directory (SVG):</strong> Load existing SVG files with automatic group detection</li>
    <li><strong>Method 2 - From Function (SVG, Embedded):</strong> Generate VegaLite charts as embedded SVG</li>
    <li><strong>Method 3 - From Function (External):</strong> Generate charts with external storage using parquet dataformat</li>
    <li><strong>Method 4 - From Directory (JPEG, Embedded):</strong> Load JPEG photographs as embedded base64 data</li>
</ul>
<h3>Image Format Comparison</h3>
<ul>
    <li><strong>SVG (Vector):</strong> Drawing instructions, scalable, small file size - perfect for charts</li>
    <li><strong>JPEG/PNG (Bitmap):</strong> Pixel data as base64, larger file size - needed for photographs</li>
</ul>
<h3>Storage Options</h3>
<ul>
    <li><strong>Embedded (csv_embedded, json_embedded):</strong> All images embedded in HTML - single portable file</li>
    <li><strong>External (csv_external, json_external, parquet):</strong> Images stored in slides/ directory - better for large datasets</li>
</ul>
<h3>Key Features</h3>
<ul>
    <li>Interactive play/pause controls</li>
    <li>Adjustable playback speed (0.05s to 5s per slide on log scale)</li>
    <li>Keyboard shortcuts for navigation</li>
    <li>Filter dropdowns for group dimensions</li>
    <li>Support for PNG, JPEG, SVG, and PDF formats</li>
    <li>Supports VegaLite.jl, Plots.jl, Makie, or custom chart objects</li>
</ul>
<p><strong>Tips:</strong></p>
<ul>
    <li>Use arrow keys to navigate slides quickly</li>
    <li>Press space to toggle play/pause</li>
    <li>Change filters to see different slide combinations</li>
    <li>Adjust the delay slider to control autoplay speed</li>
</ul>

    </div>


<hr><p align="right"><small>This page was created using <a href="https://github.com/s-baumann/JSPlots.jl">JSPlots.jl</a>.</small></p>
</body>
</html>
