<!DOCTYPE html>
<html>
<head>
    <title>JSPlots.jl</title>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@14.0.1/Arrow.es2015.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #$div_id {
            width: 100%;
            height: 600px;
        }
    </style>
    

    <!-- external libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/pivot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/d3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/c3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.19.0/export_renderers.min.js"></script>

    <!-- Prism.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    

</head>

<body>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<script type="module">
// Import parquet-wasm for Parquet file support
import * as parquet from 'https://unpkg.com/parquet-wasm@0.6.1/esm/parquet_wasm.js';

// Initialize parquet-wasm
await parquet.default();

// Make parquet available globally for loadDataset
window.parquetWasm = parquet;
window.parquetReady = true;
console.log('Parquet-wasm library loaded successfully');
</script>

<script>
// Helper function to wait for parquet-wasm to be loaded
function waitForParquet() {
    return new Promise(function(resolve) {
        if (window.parquetReady) {
            resolve();
            return;
        }
        var checkInterval = setInterval(function() {
            if (window.parquetReady) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 50);
    });
}

// Centralized data loading function
// Centralized date parsing function
// Converts ISO date strings to JavaScript Date objects
// This is the ONLY place in the package where date parsing happens
function parseDatesInData(data) {
    if (!data || data.length === 0) return data;

    // Regex patterns for ISO date formats
    var datePattern = /^\d{4}-\d{2}-\d{2}$/;  // YYYY-MM-DD
    var datetimePattern = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/;  // YYYY-MM-DDTHH:MM:SS
    var timePattern = /^\d{2}:\d{2}:\d{2}(\.\d+)?$/;  // HH:MM:SS or HH:MM:SS.sss

    // Check first row to identify date and time columns
    var firstRow = data[0];
    var dateColumns = [];
    var timeColumns = [];

    for (var key in firstRow) {
        if (firstRow.hasOwnProperty(key)) {
            var value = firstRow[key];
            if (typeof value === 'string') {
                if (datetimePattern.test(value) || datePattern.test(value)) {
                    dateColumns.push(key);
                } else if (timePattern.test(value)) {
                    timeColumns.push(key);
                }
            }
        }
    }

    // If no date or time columns found, return data unchanged
    if (dateColumns.length === 0 && timeColumns.length === 0) return data;

    // Convert date strings to Date objects and time strings to milliseconds in all rows
    return data.map(function(row) {
        var newRow = {};
        for (var key in row) {
            if (row.hasOwnProperty(key)) {
                if (dateColumns.indexOf(key) !== -1 && typeof row[key] === 'string') {
                    newRow[key] = new Date(row[key]);
                } else if (timeColumns.indexOf(key) !== -1 && typeof row[key] === 'string') {
                    // Convert HH:MM:SS or HH:MM:SS.sss to milliseconds since midnight
                    var parts = row[key].split(':');
                    var hours = parseInt(parts[0], 10);
                    var minutes = parseInt(parts[1], 10);
                    var seconds = parseFloat(parts[2]);  // Use parseFloat to handle decimal seconds
                    newRow[key] = (hours * 3600 + minutes * 60 + seconds) * 1000;
                } else {
                    newRow[key] = row[key];
                }
            }
        }
        return newRow;
    });
}

// Helper function to convert temporal values back to string format for categorical filtering
// Takes a value and returns the appropriate string representation
function temporalValueToString(value) {
    if (value instanceof Date) {
        // Convert Date to ISO string
        var year = value.getFullYear();
        var month = String(value.getMonth() + 1).padStart(2, '0');
        var day = String(value.getDate()).padStart(2, '0');
        var hours = String(value.getHours()).padStart(2, '0');
        var minutes = String(value.getMinutes()).padStart(2, '0');
        var seconds = String(value.getSeconds()).padStart(2, '0');

        // Check if this is a date-only value (time is midnight UTC)
        if (hours === '00' && minutes === '00' && seconds === '00') {
            return year + '-' + month + '-' + day;
        } else {
            return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes + ':' + seconds;
        }
    } else if (typeof value === 'number' && value >= 0 && value < 86400000) {
        // Likely a Time value (milliseconds since midnight, less than 24 hours)
        var totalSeconds = Math.floor(value / 1000);
        var hours = Math.floor(totalSeconds / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);
        var seconds = totalSeconds % 60;
        var milliseconds = value % 1000;

        var timeStr = String(hours).padStart(2, '0') + ':' +
                      String(minutes).padStart(2, '0') + ':' +
                      String(seconds).padStart(2, '0');

        // Add decimal part if there are milliseconds
        if (milliseconds > 0) {
            timeStr += '.' + String(milliseconds);
        }

        return timeStr;
    } else {
        // Return as-is for other types
        return String(value);
    }
}

// Centralized observation counting and filtering function
// Applies filters incrementally while updating observation count displays
// Returns filtered data
function applyFiltersWithCounting(allData, chartTitle, categoricalFilters, continuousFilters, filters, rangeFilters) {
    var totalObs = allData.length;

    // Update total observation count
    var totalObsElement = document.getElementById(chartTitle + '_total_obs');
    if (totalObsElement) {
        totalObsElement.textContent = totalObs + ' observations';
    }

    // Apply filters incrementally to track observation counts
    var currentData = allData;

    // Apply categorical filters and update counts
    categoricalFilters.forEach(function(col) {
        if (filters[col] && filters[col].length > 0) {
            currentData = currentData.filter(function(row) {
                var rowValueStr = temporalValueToString(row[col]);
                return filters[col].includes(rowValueStr);
            });
        }

        var countElement = document.getElementById(col + '_select_' + chartTitle + '_obs_count');
        if (countElement) {
            var pct = totalObs > 0 ? Math.round((currentData.length / totalObs) * 100) : 100;
            countElement.textContent = pct + '% (' + currentData.length + ') remaining';
        }
    });

    // Apply continuous filters and update counts
    continuousFilters.forEach(function(col) {
        if (rangeFilters[col]) {
            var range = rangeFilters[col];
            currentData = currentData.filter(function(row) {
                var rawValue = row[col];
                var value;
                if (rawValue instanceof Date) {
                    value = rawValue.getTime();
                } else {
                    value = parseFloat(rawValue);
                }
                return value >= range.min && value <= range.max;
            });
        }

        var countElement = document.getElementById(col + '_range_' + chartTitle + '_obs_count');
        if (countElement) {
            var pct = totalObs > 0 ? Math.round((currentData.length / totalObs) * 100) : 100;
            countElement.textContent = pct + '% (' + currentData.length + ') remaining';
        }
    });

    return currentData;
}

// Axis transformation functions
// These transform data values according to selected transformation type
function applyAxisTransform(values, transformType) {
    if (!values || values.length === 0) return [];

    switch(transformType) {
        case 'identity':
            return values;

        case 'log':
            return values.map(function(v) {
                return v > 0 ? Math.log(v) : NaN;
            });

        case 'z_score':
            // Z-score standardization: (x - mean) / std
            var numericVals = values.filter(function(v) { return !isNaN(v) && isFinite(v); });
            if (numericVals.length === 0) return values;

            var mean = numericVals.reduce(function(a, b) { return a + b; }, 0) / numericVals.length;
            var variance = numericVals.reduce(function(sum, v) {
                return sum + Math.pow(v - mean, 2);
            }, 0) / numericVals.length;
            var std = Math.sqrt(variance);

            if (std === 0) return values;

            return values.map(function(v) {
                if (isNaN(v) || !isFinite(v)) return NaN;
                return (v - mean) / std;
            });

        case 'quantile':
            // Rank-based transformation to [0, 1]
            // Create array of {value, originalIndex} pairs
            var indexedValues = values.map(function(v, i) {
                return { value: v, index: i };
            });

            // Filter out invalid values and sort
            var validValues = indexedValues.filter(function(item) {
                return !isNaN(item.value) && isFinite(item.value);
            }).sort(function(a, b) {
                return a.value - b.value;
            });

            if (validValues.length === 0) return values;

            // Assign ranks (0 to 1)
            var ranks = new Array(values.length).fill(NaN);
            validValues.forEach(function(item, rank) {
                // Map rank to [0, 1] where lowest = 0, highest = 1
                ranks[item.index] = validValues.length === 1 ? 0.5 : rank / (validValues.length - 1);
            });

            return ranks;

        case 'inverse_cdf':
            // Z-score followed by normal CDF transformation to [0, 1]
            var numericVals2 = values.filter(function(v) { return !isNaN(v) && isFinite(v); });
            if (numericVals2.length === 0) return values;

            var mean2 = numericVals2.reduce(function(a, b) { return a + b; }, 0) / numericVals2.length;
            var variance2 = numericVals2.reduce(function(sum, v) {
                return sum + Math.pow(v - mean2, 2);
            }, 0) / numericVals2.length;
            var std2 = Math.sqrt(variance2);

            if (std2 === 0) return values.map(function() { return 0.5; });

            return values.map(function(v) {
                if (isNaN(v) || !isFinite(v)) return NaN;
                var zscore = (v - mean2) / std2;
                return normalCDF(zscore);
            });

        default:
            return values;
    }
}

// Normal CDF (cumulative distribution function) for standard normal
function normalCDF(x) {
    // Using error function approximation
    var t = 1 / (1 + 0.2316419 * Math.abs(x));
    var d = 0.3989423 * Math.exp(-x * x / 2);
    var prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return x > 0 ? 1 - prob : prob;
}

// Inverse normal CDF (quantile function) for standard normal
function inverseNormalCDF(p) {
    // Rational approximation for inverse normal CDF
    // Valid for 0 < p < 1
    if (p <= 0 || p >= 1) {
        return NaN;
    }

    var a = [0, -3.969683028665376e+01, 2.209460984245205e+02,
             -2.759285104469687e+02, 1.383577518672690e+02,
             -3.066479806614716e+01, 2.506628277459239e+00];
    var b = [0, -5.447609879822406e+01, 1.615858368580409e+02,
             -1.556989798598866e+02, 6.680131188771972e+01,
             -1.328068155288572e+01];
    var c = [0, -7.784894002430293e-03, -3.223964580411365e-01,
             -2.400758277161838e+00, -2.549732539343734e+00,
             4.374664141464968e+00, 2.938163982698783e+00];
    var d = [0, 7.784695709041462e-03, 3.224671290700398e-01,
             2.445134137142996e+00, 3.754408661907416e+00];

    var q, r, result;

    if (p < 0.02425) {
        q = Math.sqrt(-2 * Math.log(p));
        result = (((((c[1] * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) * q + c[6]) /
                 ((((d[1] * q + d[2]) * q + d[3]) * q + d[4]) * q + 1);
    } else if (p > 0.97575) {
        q = Math.sqrt(-2 * Math.log(1 - p));
        result = -(((((c[1] * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) * q + c[6]) /
                  ((((d[1] * q + d[2]) * q + d[3]) * q + d[4]) * q + 1);
    } else {
        q = p - 0.5;
        r = q * q;
        result = (((((a[1] * r + a[2]) * r + a[3]) * r + a[4]) * r + a[5]) * r + a[6]) * q /
                 (((((b[1] * r + b[2]) * r + b[3]) * r + b[4]) * r + b[5]) * r + 1);
    }

    return result;
}

// Get axis label with transformation applied
function getAxisLabel(originalLabel, transformType) {
    switch(transformType) {
        case 'log':
            return 'log(' + originalLabel + ')';
        case 'z_score':
            return 'z(' + originalLabel + ')';
        case 'quantile':
            return 'quantile(' + originalLabel + ')';
        case 'inverse_cdf':
            return 'Î¦(' + originalLabel + ')';
        default:
            return originalLabel;
    }
}

// Setup aspect ratio control for a chart
// This should be called after the chart is first rendered
// Uses logarithmic scale for better precision at smaller aspect ratios
function setupAspectRatioControl(chartId, updateCallback) {
    var slider = document.getElementById(chartId + '_aspect_ratio_slider');
    var label = document.getElementById(chartId + '_aspect_ratio_label');

    if (!slider || !label) return; // Not all charts have aspect ratio control

    slider.addEventListener('input', function() {
        // Convert from log space to linear space
        var logValue = parseFloat(this.value);
        var aspectRatio = Math.exp(logValue);
        label.textContent = aspectRatio.toFixed(2);

        // Get current width of chart div
        var chartDiv = document.getElementById(chartId);
        if (!chartDiv) return;

        var width = chartDiv.offsetWidth;
        var height = width * aspectRatio;

        // Update chart layout with new height
        Plotly.relayout(chartId, { height: height });

        // Call the optional callback if provided
        if (updateCallback && typeof updateCallback === 'function') {
            updateCallback(height);
        }
    });

    // Trigger initial sizing
    var initialLogValue = parseFloat(slider.value);
    var initialAspectRatio = Math.exp(initialLogValue);
    label.textContent = initialAspectRatio.toFixed(2);
    var chartDiv = document.getElementById(chartId);
    if (chartDiv) {
        var width = chartDiv.offsetWidth;
        var height = width * initialAspectRatio;
        Plotly.relayout(chartId, { height: height });
    }
}

// This function parses data from embedded or external sources and returns a Promise
// Supports CSV (embedded/external), JSON (embedded/external), and Parquet (external) formats
// Usage: loadDataset('dataLabel').then(function(data) { /* use data */ });
function loadDataset(dataLabel) {
    return new Promise(function(resolve, reject) {
        var dataElement = document.getElementById(dataLabel);
        if (!dataElement) {
            reject(new Error('Data element not found: ' + dataLabel));
            return;
        }

        var format = dataElement.getAttribute('data-format') || 'csv_embedded';
        var dataSrc = dataElement.getAttribute('data-src');

        // Handle external JSON files
        if (format === 'json_external' && dataSrc) {
            fetch(dataSrc)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Parse dates in JSON data (centralized)
                    resolve(parseDatesInData(data));
                })
                .catch(function(error) {
                    console.error('Error loading external JSON:', error);
                    reject(error);
                });
            return;
        }

        // Handle external Parquet files
        if (format === 'parquet' && dataSrc) {
            // Wait for parquet-wasm to be loaded first
            waitForParquet()
                .then(function() {
                    return fetch(dataSrc);
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.arrayBuffer();
                })
                .then(function(arrayBuffer) {
                    // Use parquet-wasm to read the file
                    var uint8Array = new Uint8Array(arrayBuffer);

                    // readParquet returns an Arrow Table
                    var wasmTable = window.parquetWasm.readParquet(uint8Array);

                    // Convert to Arrow IPC stream
                    var ipcStream = wasmTable.intoIPCStream();

                    // Use Apache Arrow JS to read the IPC stream
                    var arrowTable = window.Arrow.tableFromIPC(ipcStream);

                    // Convert Arrow Table to array of JavaScript objects
                    var data = [];
                    for (var i = 0; i < arrowTable.numRows; i++) {
                        var row = {};
                        arrowTable.schema.fields.forEach(function(field) {
                            var column = arrowTable.getChild(field.name);
                            var value = column.get(i);

                            // Convert BigInt to Number (Arrow returns BigInt for Int64)
                            if (typeof value === 'bigint') {
                                value = Number(value);
                            }

                            row[field.name] = value;
                        });
                        data.push(row);
                    }

                    resolve(data);
                })
                .catch(function(error) {
                    console.error('Error loading external Parquet:', error);
                    reject(error);
                });
            return;
        }

        // Handle external CSV files
        if (format === 'csv_external' && dataSrc) {
            fetch(dataSrc)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + dataSrc + ': ' + response.statusText);
                    }
                    return response.text();
                })
                .then(function(csvText) {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            // Check for fatal errors only (not warnings)
                            var fatalErrors = results.errors.filter(function(err) {
                                return err.type !== 'Delimiter';
                            });

                            if (fatalErrors.length > 0) {
                                console.error('CSV parsing errors:', fatalErrors);
                                reject(fatalErrors);
                            } else if (results.data && results.data.length > 0) {
                                // Parse dates in CSV data (centralized)
                                resolve(parseDatesInData(results.data));
                            } else {
                                reject(new Error('No data parsed from CSV'));
                            }
                        },
                        error: function(error) {
                            console.error('CSV parsing error:', error);
                            reject(error);
                        }
                    });
                })
                .catch(function(error) {
                    console.error('Error loading external CSV:', error);
                    reject(error);
                });
            return;
        }

        // Handle embedded data
        var dataText = dataElement.textContent.trim();

        if (format === 'json_embedded') {
            // Parse JSON data
            try {
                var data = JSON.parse(dataText);
                // Parse dates in JSON data (centralized)
                resolve(parseDatesInData(data));
            } catch (error) {
                console.error('JSON parsing error:', error);
                reject(error);
            }
        } else if (format === 'csv_embedded') {
            // Parse CSV data using PapaParse
            Papa.parse(dataText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Check for fatal errors only (not warnings)
                    // PapaParse includes non-fatal warnings in errors array
                    var fatalErrors = results.errors.filter(function(err) {
                        // Filter out delimiter detection warnings - these aren't fatal
                        // (common for single-column CSVs)
                        return err.type !== 'Delimiter';
                    });

                    if (fatalErrors.length > 0) {
                        console.error('CSV parsing errors:', fatalErrors);
                        reject(fatalErrors);
                    } else if (results.data && results.data.length > 0) {
                        // Parse dates in CSV data (centralized)
                        resolve(parseDatesInData(results.data));
                    } else {
                        reject(new Error('No data parsed from CSV'));
                    }
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    reject(error);
                }
            });
        } else {
            reject(new Error('Unsupported data format: ' + format));
        }
    });
}

$(function(){

(function() {
    // Configuration
    const TIME_COL = 'time';
    const BID_COL = 'bid';
    const ASK_COL = 'ask';
    const TIME_FROM_COL = 'time_from';
    const TIME_TO_COL = 'time_to';
    const VOLUME_COL = 'volume';
    const FILL_TIME_COL = 'time';
    const QUANTITY_COL = 'quantity';
    const PRICE_COL = 'price';
    const EXECUTION_NAME_COL = 'execution_name';
    const ARRIVAL_PRICE_COL = 'arrival_price';
    const HAS_ARRIVAL = true;
    const SIDE_COL = 'side';
    const DESIRED_QUANTITY_COL = 'desired_quantity';
    const COLOR_COLS = ['venue', 'aggressiveness'];
    const COLOR_MAPS = {'venue': {'NYSE': '#ab63fa', 'ARCA': '#00cc96', 'BATS': '#636efa', 'NASDAQ': '#EF553B'}, 'aggressiveness': {'Mid': '#636efa', 'Aggressive': '#00cc96', 'Passive': '#EF553B'}};
    const COLOR_PALETTE = ['#636efa', '#EF553B', '#00cc96', '#ab63fa', '#FFA15A',
                           '#19d3f3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'];

    let tobData = [];
    let volumeData = [];
    let fillsData = [];
    let metadataData = [];
    let deselectedFills = new Set();  // Track manually deselected fills

    window.updateChart_example1_exec = function() {
        // Get current controls
        const execSelect = document.getElementById('execution_select_example1_exec');
        const currentExecution = execSelect ? execSelect.value : 'Execution_1';

        const benchmarkSelect = document.getElementById('benchmark_select_example1_exec');
        const benchmark = benchmarkSelect ? benchmarkSelect.value : (HAS_ARRIVAL ? 'arrival' : 'first');

        const showVolumeCheckbox = document.getElementById('show_volume_checkbox_example1_exec');
        const showVolume = showVolumeCheckbox ? showVolumeCheckbox.checked : true;

        // Get data for current execution
        const execMetadata = metadataData.find(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        if (!execMetadata) {
            console.error('No metadata found for execution:', currentExecution);
            return;
        }

        const execFills = fillsData.filter(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        const side = execMetadata[SIDE_COL];
        const desiredQty = execMetadata[DESIRED_QUANTITY_COL];

        // Calculate benchmark price
        let benchmarkPrice;
        if (benchmark === 'arrival' && HAS_ARRIVAL) {
            benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL];
        } else {
            // Use mid price right before first fill
            if (execFills.length > 0) {
                const firstFillTime = execFills[0][FILL_TIME_COL];
                const tobBeforeFirst = tobData.filter(row => row[TIME_COL] <= firstFillTime);
                if (tobBeforeFirst.length > 0) {
                    const lastTob = tobBeforeFirst[tobBeforeFirst.length - 1];
                    benchmarkPrice = (lastTob[BID_COL] + lastTob[ASK_COL]) / 2;
                } else {
                    benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL] || 0;
                }
            } else {
                benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL] || 0;
            }
        }

        // Render chart
        renderChart(execFills, benchmarkPrice, side, desiredQty, showVolume);

        // Render tables
        renderFillsTable(execFills, benchmarkPrice, side, desiredQty);
        renderSummaryTable(execFills, benchmarkPrice, side, desiredQty);
    };

    function renderChart(fills, benchmarkPrice, side, desiredQty, showVolume) {
        const traces = [];

        // Bid and ask lines
        const tobTimes = tobData.map(row => row[TIME_COL]);
        const bids = tobData.map(row => row[BID_COL]);
        const asks = tobData.map(row => row[ASK_COL]);

        traces.push({
            x: tobTimes,
            y: bids,
            type: 'scatter',
            mode: 'lines',
            name: 'Bid',
            line: {color: '#EF553B', width: 2},
            xaxis: 'x',
            yaxis: 'y'
        });

        traces.push({
            x: tobTimes,
            y: asks,
            type: 'scatter',
            mode: 'lines',
            name: 'Ask',
            line: {color: '#00cc96', width: 2},
            xaxis: 'x',
            yaxis: 'y'
        });

        // Volume bars if enabled
        if (showVolume) {
            const volTimes = volumeData.map(row => row[TIME_FROM_COL]);
            const volumes = volumeData.map(row => row[VOLUME_COL]);

            traces.push({
                x: volTimes,
                y: volumes,
                type: 'bar',
                name: 'Volume',
                marker: {color: '#636efa'},
                xaxis: 'x',
                yaxis: 'y2'
            });
        }

        // Fill points
        const activeFills = fills.filter((_, idx) => !deselectedFills.has(idx));

        if (COLOR_COLS.length > 0) {
            // Group by first color column
            const colorCol = COLOR_COLS[0];
            const fillsByColor = {};
            activeFills.forEach((fill, idx) => {
                const colorValue = String(fill[colorCol]);
                if (!fillsByColor[colorValue]) fillsByColor[colorValue] = [];
                fillsByColor[colorValue].push({fill, originalIdx: idx});
            });

            for (let colorValue in fillsByColor) {
                const items = fillsByColor[colorValue];
                const fillGroup = items.map(item => item.fill);
                const color = COLOR_MAPS[colorCol] && COLOR_MAPS[colorCol][colorValue] ?
                             COLOR_MAPS[colorCol][colorValue] :
                             COLOR_PALETTE[0];

                traces.push({
                    x: fillGroup.map(f => f[FILL_TIME_COL]),
                    y: fillGroup.map(f => f[PRICE_COL]),
                    type: 'scatter',
                    mode: 'markers',
                    name: colorValue,
                    marker: {
                        size: fillGroup.map(f => Math.max(5, 5 + Math.log(f[QUANTITY_COL] + 1) * 2)),
                        color: color
                    },
                    xaxis: 'x',
                    yaxis: 'y'
                });
            }
        } else {
            // No color grouping
            traces.push({
                x: activeFills.map(f => f[FILL_TIME_COL]),
                y: activeFills.map(f => f[PRICE_COL]),
                type: 'scatter',
                mode: 'markers',
                name: 'Fills',
                marker: {
                    size: activeFills.map(f => Math.max(5, 5 + Math.log(f[QUANTITY_COL] + 1) * 2)),
                    color: '#636efa'
                },
                xaxis: 'x',
                yaxis: 'y'
            });
        }

        // Calculate shortfall timeline
        const sideMultiplier = side === 'buy' ? 1 : -1;
        const shortfallTimes = [];
        const cumImpShortfalls = [];
        const cumVwapShortfalls = [];

        let cumImpShortfall = 0;
        let cumVwapShortfall = 0;

        fills.forEach((fill, idx) => {
            if (deselectedFills.has(idx)) return;

            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;

            cumImpShortfall += impShortfall;
            cumVwapShortfall += vwapShortfall;

            shortfallTimes.push(fill[FILL_TIME_COL]);
            cumImpShortfalls.push(cumImpShortfall);
            cumVwapShortfalls.push(cumVwapShortfall);
        });

        // Add shortfall timeline traces
        traces.push({
            x: shortfallTimes,
            y: cumImpShortfalls,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Imp. Shortfall',
            line: {color: '#FFA15A', width: 2},
            marker: {size: 6},
            xaxis: 'x',
            yaxis: 'y3',
            hovertemplate: 'Time: %{x}<br>Imp. Shortfall: %{y:.2f}<extra></extra>'
        });

        traces.push({
            x: shortfallTimes,
            y: cumVwapShortfalls,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'VWAP Shortfall',
            line: {color: '#ab63fa', width: 2},
            marker: {size: 6},
            xaxis: 'x',
            yaxis: 'y3',
            hovertemplate: 'Time: %{x}<br>VWAP Shortfall: %{y:.2f}<extra></extra>'
        });

        // Add zero reference line for shortfall chart
        if (shortfallTimes.length > 0) {
            traces.push({
                x: [shortfallTimes[0], shortfallTimes[shortfallTimes.length - 1]],
                y: [0, 0],
                type: 'scatter',
                mode: 'lines',
                name: 'Zero',
                line: {color: 'gray', width: 1, dash: 'dash'},
                xaxis: 'x',
                yaxis: 'y3',
                showlegend: false,
                hoverinfo: 'skip'
            });
        }

        // Adjust layout for three subplots
        const layout = {
            xaxis: {title: 'Time', anchor: showVolume ? 'y3' : 'y3'},
            yaxis: {
                title: 'Price',
                domain: showVolume ? [0.45, 1] : [0.35, 1]
            },
            yaxis3: {
                title: 'Cumulative Shortfall',
                domain: [0, showVolume ? 0.25 : 0.3],
                anchor: 'x'
            },
            hovermode: 'closest',
            showlegend: true
        };

        if (showVolume) {
            layout.yaxis2 = {
                title: 'Volume',
                domain: [0.3, 0.4],
                anchor: 'x'
            };
        }

        Plotly.newPlot('example1_exec', traces, layout, {responsive: true});
    }

    function calculateRollingVWAP(fills, upToIndex) {
        // Calculate VWAP for active fills up to and including upToIndex
        let totalValue = 0;
        let totalQty = 0;
        for (let i = 0; i <= upToIndex; i++) {
            if (!deselectedFills.has(i)) {
                const fill = fills[i];
                totalValue += fill[PRICE_COL] * fill[QUANTITY_COL];
                totalQty += fill[QUANTITY_COL];
            }
        }
        return totalQty > 0 ? totalValue / totalQty : 0;
    }

    function getSpreadCrossing(fill, side) {
        // Find the bid/ask at the fill time
        const fillTime = fill[FILL_TIME_COL];
        const tobAtFill = tobData.filter(row => row[TIME_COL] <= fillTime);
        if (tobAtFill.length === 0) return null;

        const lastTob = tobAtFill[tobAtFill.length - 1];
        const bid = lastTob[BID_COL];
        const ask = lastTob[ASK_COL];
        const spread = ask - bid;

        if (spread <= 0) return null;

        const fillPrice = fill[PRICE_COL];
        if (side === 'buy') {
            // 0 = bought at bid (neartouch), 1 = bought at ask (fartouch)
            return Math.max(0, Math.min(1, (fillPrice - bid) / spread));
        } else {
            // 0 = sold at ask (neartouch), 1 = sold at bid (fartouch)
            return Math.max(0, Math.min(1, (ask - fillPrice) / spread));
        }
    }

    function renderFillsTable(fills, benchmarkPrice, side, desiredQty) {
        const container = document.getElementById('fills_table_example1_exec');
        if (!container) return;

        let html = '<h4>Fill Details</h4>';
        html += '<table id="fills_table_content_example1_exec" style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Time</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Price</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>';
        COLOR_COLS.forEach(col => {
            html += `<th style="border: 1px solid #ddd; padding: 8px;">${col}</th>`;
        });
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Imp. Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">VWAP Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Spread Cross %</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Remaining %</th>';
        html += '</tr></thead><tbody>';

        let cumQty = 0;
        let cumImpShortfall = 0;
        let cumVwapShortfall = 0;

        fills.forEach((fill, idx) => {
            const isDeselected = deselectedFills.has(idx);
            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];
            const sideMultiplier = side === 'buy' ? 1 : -1;

            if (!isDeselected) {
                cumQty += qty;
            }

            const remaining = Math.max(0, (desiredQty - cumQty) / desiredQty * 100);

            // Calculate rolling VWAP up to this fill
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;
            const spreadCrossing = getSpreadCrossing(fill, side);

            if (!isDeselected) {
                cumImpShortfall += impShortfall;
                cumVwapShortfall += vwapShortfall;
            }

            const bgColor = isDeselected ? '#f0f0f0' : 'white';

            html += `<tr id="fill_row_${idx}_example1_exec"
                         style="background-color: ${bgColor}; cursor: pointer; transition: background-color 0.2s;"
                         onclick="toggleFill_example1_exec(${idx})"
                         onmouseover="highlightFill_example1_exec(${idx}, true)"
                         onmouseout="highlightFill_example1_exec(${idx}, false)">`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${fill[FILL_TIME_COL]}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${price.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${qty}</td>`;
            COLOR_COLS.forEach(col => {
                html += `<td style="border: 1px solid #ddd; padding: 8px;">${fill[col]}</td>`;
            });
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${cumImpShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${cumVwapShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${spreadCrossing !== null ? (spreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${remaining.toFixed(1)}%</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderSummaryTable(fills, benchmarkPrice, side, desiredQty) {
        const container = document.getElementById('summary_table_example1_exec');
        if (!container) return;

        // Get active fills only
        const activeFills = fills.filter((_, idx) => !deselectedFills.has(idx));

        let html = '<h4>Summary by Category</h4>';

        if (COLOR_COLS.length === 0) {
            // No color columns, just show overall summary
            html += '<p>No categories to aggregate by. Add color_cols for detailed breakdown.</p>';
            container.innerHTML = html;
            return;
        }

        // Use first color column for aggregation
        const colorCol = COLOR_COLS[0];
        const categories = {};

        const sideMultiplier = side === 'buy' ? 1 : -1;

        // Need to iterate through all fills (not just active) to get correct indices for rolling VWAP
        fills.forEach((fill, idx) => {
            if (deselectedFills.has(idx)) return; // Skip deselected fills

            const category = String(fill[colorCol]);
            if (!categories[category]) {
                categories[category] = {
                    totalImpShortfall: 0,
                    totalVwapShortfall: 0,
                    spreadCrossings: [],
                    count: 0,
                    totalQty: 0
                };
            }

            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];

            // Use rolling VWAP up to this fill
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;
            const spreadCrossing = getSpreadCrossing(fill, side);

            categories[category].totalImpShortfall += impShortfall;
            categories[category].totalVwapShortfall += vwapShortfall;
            if (spreadCrossing !== null) {
                categories[category].spreadCrossings.push(spreadCrossing);
            }
            categories[category].count += 1;
            categories[category].totalQty += qty;
        });

        // Calculate overall totals
        let overallImpShortfall = 0;
        let overallVwapShortfall = 0;
        let overallSpreadCrossings = [];
        let overallCount = 0;
        let overallQty = 0;

        for (let cat in categories) {
            overallImpShortfall += categories[cat].totalImpShortfall;
            overallVwapShortfall += categories[cat].totalVwapShortfall;
            overallSpreadCrossings.push(...categories[cat].spreadCrossings);
            overallCount += categories[cat].count;
            overallQty += categories[cat].totalQty;
        }

        html += '<table style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += `<th style="border: 1px solid #ddd; padding: 8px;">${colorCol}</th>`;
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Fills</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Imp. Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">VWAP Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Avg Spread Cross %</th>';
        html += '</tr></thead><tbody>';

        // Sort categories alphabetically
        const sortedCategories = Object.keys(categories).sort();

        sortedCategories.forEach(category => {
            const data = categories[category];
            const avgSpreadCrossing = data.spreadCrossings.length > 0 ?
                data.spreadCrossings.reduce((a, b) => a + b, 0) / data.spreadCrossings.length : null;

            html += '<tr>';
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${category}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.count}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalQty}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalImpShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalVwapShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${avgSpreadCrossing !== null ? (avgSpreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
            html += '</tr>';
        });

        // Add overall row
        const overallAvgSpreadCrossing = overallSpreadCrossings.length > 0 ?
            overallSpreadCrossings.reduce((a, b) => a + b, 0) / overallSpreadCrossings.length : null;

        html += '<tr style="font-weight: bold; background-color: #f9f9f9;">';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">Overall</td>';
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallCount}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallQty}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallImpShortfall.toFixed(2)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallVwapShortfall.toFixed(2)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallAvgSpreadCrossing !== null ? (overallAvgSpreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
        html += '</tr>';

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    window.toggleFill_example1_exec = function(idx) {
        if (deselectedFills.has(idx)) {
            deselectedFills.delete(idx);
        } else {
            deselectedFills.add(idx);
        }
        updateChart_example1_exec();
    };

    window.highlightFill_example1_exec = function(idx, isHighlighted) {
        // Get the chart element
        const chartDiv = document.getElementById('example1_exec');
        if (!chartDiv || !chartDiv.data) return;

        // Find which trace contains this fill
        const execSelect = document.getElementById('execution_select_example1_exec');
        const currentExecution = execSelect ? execSelect.value : 'Execution_1';
        const execFills = fillsData.filter(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        const fill = execFills[idx];
        if (!fill) return;

        // Find the trace and point index
        const fillTime = fill[FILL_TIME_COL];
        const fillPrice = fill[PRICE_COL];

        // Iterate through traces to find the matching fill point
        chartDiv.data.forEach((trace, traceIdx) => {
            if (trace.mode === 'markers' || trace.mode === 'markers+lines') {
                trace.x.forEach((x, pointIdx) => {
                    if (x === fillTime && Math.abs(trace.y[pointIdx] - fillPrice) < 0.01) {
                        // Found the point, update its marker
                        const update = {};
                        if (isHighlighted) {
                            // Increase size and add border
                            const currentSize = trace.marker.size[pointIdx] || trace.marker.size || 8;
                            update['marker.size'] = trace.marker.size.map((s, i) =>
                                i === pointIdx ? s * 1.5 : s
                            );
                            update['marker.line'] = {
                                color: 'black',
                                width: trace.marker.size.map((s, i) => i === pointIdx ? 2 : 0)
                            };
                        } else {
                            // Reset to original size
                            const originalSize = Math.max(5, 5 + Math.log(fill[QUANTITY_COL] + 1) * 2);
                            update['marker.size'] = trace.marker.size.map((s, i) =>
                                i === pointIdx ? originalSize : s
                            );
                            update['marker.line'] = {width: 0};
                        }
                        Plotly.restyle(chartDiv, update, [traceIdx]);
                    }
                });
            }
        });
    };

    // Load data
    Promise.all([
        loadDataset('tob_data1'),
        loadDataset('volume_data1'),
        loadDataset('fills_data1'),
        loadDataset('metadata1')
    ]).then(function([tob, vol, fills, metadata]) {
        tobData = tob;
        volumeData = vol;
        fillsData = fills;
        metadataData = metadata;

        updateChart_example1_exec();
    }).catch(function(error) {
        console.error('Error loading data for chart example1_exec:', error);
    });
})();
(function() {
    // Configuration
    const TIME_COL = 'time';
    const BID_COL = 'bid';
    const ASK_COL = 'ask';
    const TIME_FROM_COL = 'time_from';
    const TIME_TO_COL = 'time_to';
    const VOLUME_COL = 'volume';
    const FILL_TIME_COL = 'time';
    const QUANTITY_COL = 'quantity';
    const PRICE_COL = 'price';
    const EXECUTION_NAME_COL = 'execution_name';
    const ARRIVAL_PRICE_COL = '';
    const HAS_ARRIVAL = false;
    const SIDE_COL = 'side';
    const DESIRED_QUANTITY_COL = 'desired_quantity';
    const COLOR_COLS = ['strategy', 'fill_type'];
    const COLOR_MAPS = {'strategy': {'VWAP': '#ab63fa', 'POV': '#00cc96', 'Opportunistic': '#636efa', 'TWAP': '#EF553B'}, 'fill_type': {'Market': '#EF553B', 'Peg': '#00cc96', 'Limit': '#636efa'}};
    const COLOR_PALETTE = ['#636efa', '#EF553B', '#00cc96', '#ab63fa', '#FFA15A',
                           '#19d3f3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'];

    let tobData = [];
    let volumeData = [];
    let fillsData = [];
    let metadataData = [];
    let deselectedFills = new Set();  // Track manually deselected fills

    window.updateChart_example2_exec = function() {
        // Get current controls
        const execSelect = document.getElementById('execution_select_example2_exec');
        const currentExecution = execSelect ? execSelect.value : 'Execution_2';

        const benchmarkSelect = document.getElementById('benchmark_select_example2_exec');
        const benchmark = benchmarkSelect ? benchmarkSelect.value : (HAS_ARRIVAL ? 'arrival' : 'first');

        const showVolumeCheckbox = document.getElementById('show_volume_checkbox_example2_exec');
        const showVolume = showVolumeCheckbox ? showVolumeCheckbox.checked : true;

        // Get data for current execution
        const execMetadata = metadataData.find(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        if (!execMetadata) {
            console.error('No metadata found for execution:', currentExecution);
            return;
        }

        const execFills = fillsData.filter(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        const side = execMetadata[SIDE_COL];
        const desiredQty = execMetadata[DESIRED_QUANTITY_COL];

        // Calculate benchmark price
        let benchmarkPrice;
        if (benchmark === 'arrival' && HAS_ARRIVAL) {
            benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL];
        } else {
            // Use mid price right before first fill
            if (execFills.length > 0) {
                const firstFillTime = execFills[0][FILL_TIME_COL];
                const tobBeforeFirst = tobData.filter(row => row[TIME_COL] <= firstFillTime);
                if (tobBeforeFirst.length > 0) {
                    const lastTob = tobBeforeFirst[tobBeforeFirst.length - 1];
                    benchmarkPrice = (lastTob[BID_COL] + lastTob[ASK_COL]) / 2;
                } else {
                    benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL] || 0;
                }
            } else {
                benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL] || 0;
            }
        }

        // Render chart
        renderChart(execFills, benchmarkPrice, side, desiredQty, showVolume);

        // Render tables
        renderFillsTable(execFills, benchmarkPrice, side, desiredQty);
        renderSummaryTable(execFills, benchmarkPrice, side, desiredQty);
    };

    function renderChart(fills, benchmarkPrice, side, desiredQty, showVolume) {
        const traces = [];

        // Bid and ask lines
        const tobTimes = tobData.map(row => row[TIME_COL]);
        const bids = tobData.map(row => row[BID_COL]);
        const asks = tobData.map(row => row[ASK_COL]);

        traces.push({
            x: tobTimes,
            y: bids,
            type: 'scatter',
            mode: 'lines',
            name: 'Bid',
            line: {color: '#EF553B', width: 2},
            xaxis: 'x',
            yaxis: 'y'
        });

        traces.push({
            x: tobTimes,
            y: asks,
            type: 'scatter',
            mode: 'lines',
            name: 'Ask',
            line: {color: '#00cc96', width: 2},
            xaxis: 'x',
            yaxis: 'y'
        });

        // Volume bars if enabled
        if (showVolume) {
            const volTimes = volumeData.map(row => row[TIME_FROM_COL]);
            const volumes = volumeData.map(row => row[VOLUME_COL]);

            traces.push({
                x: volTimes,
                y: volumes,
                type: 'bar',
                name: 'Volume',
                marker: {color: '#636efa'},
                xaxis: 'x',
                yaxis: 'y2'
            });
        }

        // Fill points
        const activeFills = fills.filter((_, idx) => !deselectedFills.has(idx));

        if (COLOR_COLS.length > 0) {
            // Group by first color column
            const colorCol = COLOR_COLS[0];
            const fillsByColor = {};
            activeFills.forEach((fill, idx) => {
                const colorValue = String(fill[colorCol]);
                if (!fillsByColor[colorValue]) fillsByColor[colorValue] = [];
                fillsByColor[colorValue].push({fill, originalIdx: idx});
            });

            for (let colorValue in fillsByColor) {
                const items = fillsByColor[colorValue];
                const fillGroup = items.map(item => item.fill);
                const color = COLOR_MAPS[colorCol] && COLOR_MAPS[colorCol][colorValue] ?
                             COLOR_MAPS[colorCol][colorValue] :
                             COLOR_PALETTE[0];

                traces.push({
                    x: fillGroup.map(f => f[FILL_TIME_COL]),
                    y: fillGroup.map(f => f[PRICE_COL]),
                    type: 'scatter',
                    mode: 'markers',
                    name: colorValue,
                    marker: {
                        size: fillGroup.map(f => Math.max(5, 5 + Math.log(f[QUANTITY_COL] + 1) * 2)),
                        color: color
                    },
                    xaxis: 'x',
                    yaxis: 'y'
                });
            }
        } else {
            // No color grouping
            traces.push({
                x: activeFills.map(f => f[FILL_TIME_COL]),
                y: activeFills.map(f => f[PRICE_COL]),
                type: 'scatter',
                mode: 'markers',
                name: 'Fills',
                marker: {
                    size: activeFills.map(f => Math.max(5, 5 + Math.log(f[QUANTITY_COL] + 1) * 2)),
                    color: '#636efa'
                },
                xaxis: 'x',
                yaxis: 'y'
            });
        }

        // Calculate shortfall timeline
        const sideMultiplier = side === 'buy' ? 1 : -1;
        const shortfallTimes = [];
        const cumImpShortfalls = [];
        const cumVwapShortfalls = [];

        let cumImpShortfall = 0;
        let cumVwapShortfall = 0;

        fills.forEach((fill, idx) => {
            if (deselectedFills.has(idx)) return;

            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;

            cumImpShortfall += impShortfall;
            cumVwapShortfall += vwapShortfall;

            shortfallTimes.push(fill[FILL_TIME_COL]);
            cumImpShortfalls.push(cumImpShortfall);
            cumVwapShortfalls.push(cumVwapShortfall);
        });

        // Add shortfall timeline traces
        traces.push({
            x: shortfallTimes,
            y: cumImpShortfalls,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Imp. Shortfall',
            line: {color: '#FFA15A', width: 2},
            marker: {size: 6},
            xaxis: 'x',
            yaxis: 'y3',
            hovertemplate: 'Time: %{x}<br>Imp. Shortfall: %{y:.2f}<extra></extra>'
        });

        traces.push({
            x: shortfallTimes,
            y: cumVwapShortfalls,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'VWAP Shortfall',
            line: {color: '#ab63fa', width: 2},
            marker: {size: 6},
            xaxis: 'x',
            yaxis: 'y3',
            hovertemplate: 'Time: %{x}<br>VWAP Shortfall: %{y:.2f}<extra></extra>'
        });

        // Add zero reference line for shortfall chart
        if (shortfallTimes.length > 0) {
            traces.push({
                x: [shortfallTimes[0], shortfallTimes[shortfallTimes.length - 1]],
                y: [0, 0],
                type: 'scatter',
                mode: 'lines',
                name: 'Zero',
                line: {color: 'gray', width: 1, dash: 'dash'},
                xaxis: 'x',
                yaxis: 'y3',
                showlegend: false,
                hoverinfo: 'skip'
            });
        }

        // Adjust layout for three subplots
        const layout = {
            xaxis: {title: 'Time', anchor: showVolume ? 'y3' : 'y3'},
            yaxis: {
                title: 'Price',
                domain: showVolume ? [0.45, 1] : [0.35, 1]
            },
            yaxis3: {
                title: 'Cumulative Shortfall',
                domain: [0, showVolume ? 0.25 : 0.3],
                anchor: 'x'
            },
            hovermode: 'closest',
            showlegend: true
        };

        if (showVolume) {
            layout.yaxis2 = {
                title: 'Volume',
                domain: [0.3, 0.4],
                anchor: 'x'
            };
        }

        Plotly.newPlot('example2_exec', traces, layout, {responsive: true});
    }

    function calculateRollingVWAP(fills, upToIndex) {
        // Calculate VWAP for active fills up to and including upToIndex
        let totalValue = 0;
        let totalQty = 0;
        for (let i = 0; i <= upToIndex; i++) {
            if (!deselectedFills.has(i)) {
                const fill = fills[i];
                totalValue += fill[PRICE_COL] * fill[QUANTITY_COL];
                totalQty += fill[QUANTITY_COL];
            }
        }
        return totalQty > 0 ? totalValue / totalQty : 0;
    }

    function getSpreadCrossing(fill, side) {
        // Find the bid/ask at the fill time
        const fillTime = fill[FILL_TIME_COL];
        const tobAtFill = tobData.filter(row => row[TIME_COL] <= fillTime);
        if (tobAtFill.length === 0) return null;

        const lastTob = tobAtFill[tobAtFill.length - 1];
        const bid = lastTob[BID_COL];
        const ask = lastTob[ASK_COL];
        const spread = ask - bid;

        if (spread <= 0) return null;

        const fillPrice = fill[PRICE_COL];
        if (side === 'buy') {
            // 0 = bought at bid (neartouch), 1 = bought at ask (fartouch)
            return Math.max(0, Math.min(1, (fillPrice - bid) / spread));
        } else {
            // 0 = sold at ask (neartouch), 1 = sold at bid (fartouch)
            return Math.max(0, Math.min(1, (ask - fillPrice) / spread));
        }
    }

    function renderFillsTable(fills, benchmarkPrice, side, desiredQty) {
        const container = document.getElementById('fills_table_example2_exec');
        if (!container) return;

        let html = '<h4>Fill Details</h4>';
        html += '<table id="fills_table_content_example2_exec" style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Time</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Price</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>';
        COLOR_COLS.forEach(col => {
            html += `<th style="border: 1px solid #ddd; padding: 8px;">${col}</th>`;
        });
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Imp. Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">VWAP Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Spread Cross %</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Remaining %</th>';
        html += '</tr></thead><tbody>';

        let cumQty = 0;
        let cumImpShortfall = 0;
        let cumVwapShortfall = 0;

        fills.forEach((fill, idx) => {
            const isDeselected = deselectedFills.has(idx);
            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];
            const sideMultiplier = side === 'buy' ? 1 : -1;

            if (!isDeselected) {
                cumQty += qty;
            }

            const remaining = Math.max(0, (desiredQty - cumQty) / desiredQty * 100);

            // Calculate rolling VWAP up to this fill
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;
            const spreadCrossing = getSpreadCrossing(fill, side);

            if (!isDeselected) {
                cumImpShortfall += impShortfall;
                cumVwapShortfall += vwapShortfall;
            }

            const bgColor = isDeselected ? '#f0f0f0' : 'white';

            html += `<tr id="fill_row_${idx}_example2_exec"
                         style="background-color: ${bgColor}; cursor: pointer; transition: background-color 0.2s;"
                         onclick="toggleFill_example2_exec(${idx})"
                         onmouseover="highlightFill_example2_exec(${idx}, true)"
                         onmouseout="highlightFill_example2_exec(${idx}, false)">`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${fill[FILL_TIME_COL]}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${price.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${qty}</td>`;
            COLOR_COLS.forEach(col => {
                html += `<td style="border: 1px solid #ddd; padding: 8px;">${fill[col]}</td>`;
            });
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${cumImpShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${cumVwapShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${spreadCrossing !== null ? (spreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${remaining.toFixed(1)}%</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderSummaryTable(fills, benchmarkPrice, side, desiredQty) {
        const container = document.getElementById('summary_table_example2_exec');
        if (!container) return;

        // Get active fills only
        const activeFills = fills.filter((_, idx) => !deselectedFills.has(idx));

        let html = '<h4>Summary by Category</h4>';

        if (COLOR_COLS.length === 0) {
            // No color columns, just show overall summary
            html += '<p>No categories to aggregate by. Add color_cols for detailed breakdown.</p>';
            container.innerHTML = html;
            return;
        }

        // Use first color column for aggregation
        const colorCol = COLOR_COLS[0];
        const categories = {};

        const sideMultiplier = side === 'buy' ? 1 : -1;

        // Need to iterate through all fills (not just active) to get correct indices for rolling VWAP
        fills.forEach((fill, idx) => {
            if (deselectedFills.has(idx)) return; // Skip deselected fills

            const category = String(fill[colorCol]);
            if (!categories[category]) {
                categories[category] = {
                    totalImpShortfall: 0,
                    totalVwapShortfall: 0,
                    spreadCrossings: [],
                    count: 0,
                    totalQty: 0
                };
            }

            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];

            // Use rolling VWAP up to this fill
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;
            const spreadCrossing = getSpreadCrossing(fill, side);

            categories[category].totalImpShortfall += impShortfall;
            categories[category].totalVwapShortfall += vwapShortfall;
            if (spreadCrossing !== null) {
                categories[category].spreadCrossings.push(spreadCrossing);
            }
            categories[category].count += 1;
            categories[category].totalQty += qty;
        });

        // Calculate overall totals
        let overallImpShortfall = 0;
        let overallVwapShortfall = 0;
        let overallSpreadCrossings = [];
        let overallCount = 0;
        let overallQty = 0;

        for (let cat in categories) {
            overallImpShortfall += categories[cat].totalImpShortfall;
            overallVwapShortfall += categories[cat].totalVwapShortfall;
            overallSpreadCrossings.push(...categories[cat].spreadCrossings);
            overallCount += categories[cat].count;
            overallQty += categories[cat].totalQty;
        }

        html += '<table style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += `<th style="border: 1px solid #ddd; padding: 8px;">${colorCol}</th>`;
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Fills</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Imp. Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">VWAP Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Avg Spread Cross %</th>';
        html += '</tr></thead><tbody>';

        // Sort categories alphabetically
        const sortedCategories = Object.keys(categories).sort();

        sortedCategories.forEach(category => {
            const data = categories[category];
            const avgSpreadCrossing = data.spreadCrossings.length > 0 ?
                data.spreadCrossings.reduce((a, b) => a + b, 0) / data.spreadCrossings.length : null;

            html += '<tr>';
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${category}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.count}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalQty}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalImpShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalVwapShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${avgSpreadCrossing !== null ? (avgSpreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
            html += '</tr>';
        });

        // Add overall row
        const overallAvgSpreadCrossing = overallSpreadCrossings.length > 0 ?
            overallSpreadCrossings.reduce((a, b) => a + b, 0) / overallSpreadCrossings.length : null;

        html += '<tr style="font-weight: bold; background-color: #f9f9f9;">';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">Overall</td>';
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallCount}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallQty}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallImpShortfall.toFixed(2)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallVwapShortfall.toFixed(2)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallAvgSpreadCrossing !== null ? (overallAvgSpreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
        html += '</tr>';

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    window.toggleFill_example2_exec = function(idx) {
        if (deselectedFills.has(idx)) {
            deselectedFills.delete(idx);
        } else {
            deselectedFills.add(idx);
        }
        updateChart_example2_exec();
    };

    window.highlightFill_example2_exec = function(idx, isHighlighted) {
        // Get the chart element
        const chartDiv = document.getElementById('example2_exec');
        if (!chartDiv || !chartDiv.data) return;

        // Find which trace contains this fill
        const execSelect = document.getElementById('execution_select_example2_exec');
        const currentExecution = execSelect ? execSelect.value : 'Execution_2';
        const execFills = fillsData.filter(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        const fill = execFills[idx];
        if (!fill) return;

        // Find the trace and point index
        const fillTime = fill[FILL_TIME_COL];
        const fillPrice = fill[PRICE_COL];

        // Iterate through traces to find the matching fill point
        chartDiv.data.forEach((trace, traceIdx) => {
            if (trace.mode === 'markers' || trace.mode === 'markers+lines') {
                trace.x.forEach((x, pointIdx) => {
                    if (x === fillTime && Math.abs(trace.y[pointIdx] - fillPrice) < 0.01) {
                        // Found the point, update its marker
                        const update = {};
                        if (isHighlighted) {
                            // Increase size and add border
                            const currentSize = trace.marker.size[pointIdx] || trace.marker.size || 8;
                            update['marker.size'] = trace.marker.size.map((s, i) =>
                                i === pointIdx ? s * 1.5 : s
                            );
                            update['marker.line'] = {
                                color: 'black',
                                width: trace.marker.size.map((s, i) => i === pointIdx ? 2 : 0)
                            };
                        } else {
                            // Reset to original size
                            const originalSize = Math.max(5, 5 + Math.log(fill[QUANTITY_COL] + 1) * 2);
                            update['marker.size'] = trace.marker.size.map((s, i) =>
                                i === pointIdx ? originalSize : s
                            );
                            update['marker.line'] = {width: 0};
                        }
                        Plotly.restyle(chartDiv, update, [traceIdx]);
                    }
                });
            }
        });
    };

    // Load data
    Promise.all([
        loadDataset('tob_data2'),
        loadDataset('volume_data2'),
        loadDataset('fills_data2'),
        loadDataset('metadata2')
    ]).then(function([tob, vol, fills, metadata]) {
        tobData = tob;
        volumeData = vol;
        fillsData = fills;
        metadataData = metadata;

        updateChart_example2_exec();
    }).catch(function(error) {
        console.error('Error loading data for chart example2_exec:', error);
    });
})();
(function() {
    // Configuration
    const TIME_COL = 'time';
    const BID_COL = 'bid';
    const ASK_COL = 'ask';
    const TIME_FROM_COL = 'time_from';
    const TIME_TO_COL = 'time_to';
    const VOLUME_COL = 'volume';
    const FILL_TIME_COL = 'time';
    const QUANTITY_COL = 'quantity';
    const PRICE_COL = 'price';
    const EXECUTION_NAME_COL = 'execution_name';
    const ARRIVAL_PRICE_COL = 'arrival_price';
    const HAS_ARRIVAL = true;
    const SIDE_COL = 'side';
    const DESIRED_QUANTITY_COL = 'desired_quantity';
    const COLOR_COLS = ['urgency', 'venue'];
    const COLOR_MAPS = {'urgency': {'Low': '#EF553B', 'High': '#636efa'}, 'venue': {'NYSE': '#EF553B', 'ARCA': '#00cc96', 'BATS': '#ab63fa', 'NASDAQ': '#636efa'}};
    const COLOR_PALETTE = ['#636efa', '#EF553B', '#00cc96', '#ab63fa', '#FFA15A',
                           '#19d3f3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'];

    let tobData = [];
    let volumeData = [];
    let fillsData = [];
    let metadataData = [];
    let deselectedFills = new Set();  // Track manually deselected fills

    window.updateChart_example3_exec = function() {
        // Get current controls
        const execSelect = document.getElementById('execution_select_example3_exec');
        const currentExecution = execSelect ? execSelect.value : 'Aggressive_Buy';

        const benchmarkSelect = document.getElementById('benchmark_select_example3_exec');
        const benchmark = benchmarkSelect ? benchmarkSelect.value : (HAS_ARRIVAL ? 'arrival' : 'first');

        const showVolumeCheckbox = document.getElementById('show_volume_checkbox_example3_exec');
        const showVolume = showVolumeCheckbox ? showVolumeCheckbox.checked : true;

        // Get data for current execution
        const execMetadata = metadataData.find(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        if (!execMetadata) {
            console.error('No metadata found for execution:', currentExecution);
            return;
        }

        const execFills = fillsData.filter(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        const side = execMetadata[SIDE_COL];
        const desiredQty = execMetadata[DESIRED_QUANTITY_COL];

        // Calculate benchmark price
        let benchmarkPrice;
        if (benchmark === 'arrival' && HAS_ARRIVAL) {
            benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL];
        } else {
            // Use mid price right before first fill
            if (execFills.length > 0) {
                const firstFillTime = execFills[0][FILL_TIME_COL];
                const tobBeforeFirst = tobData.filter(row => row[TIME_COL] <= firstFillTime);
                if (tobBeforeFirst.length > 0) {
                    const lastTob = tobBeforeFirst[tobBeforeFirst.length - 1];
                    benchmarkPrice = (lastTob[BID_COL] + lastTob[ASK_COL]) / 2;
                } else {
                    benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL] || 0;
                }
            } else {
                benchmarkPrice = execMetadata[ARRIVAL_PRICE_COL] || 0;
            }
        }

        // Render chart
        renderChart(execFills, benchmarkPrice, side, desiredQty, showVolume);

        // Render tables
        renderFillsTable(execFills, benchmarkPrice, side, desiredQty);
        renderSummaryTable(execFills, benchmarkPrice, side, desiredQty);
    };

    function renderChart(fills, benchmarkPrice, side, desiredQty, showVolume) {
        const traces = [];

        // Bid and ask lines
        const tobTimes = tobData.map(row => row[TIME_COL]);
        const bids = tobData.map(row => row[BID_COL]);
        const asks = tobData.map(row => row[ASK_COL]);

        traces.push({
            x: tobTimes,
            y: bids,
            type: 'scatter',
            mode: 'lines',
            name: 'Bid',
            line: {color: '#EF553B', width: 2},
            xaxis: 'x',
            yaxis: 'y'
        });

        traces.push({
            x: tobTimes,
            y: asks,
            type: 'scatter',
            mode: 'lines',
            name: 'Ask',
            line: {color: '#00cc96', width: 2},
            xaxis: 'x',
            yaxis: 'y'
        });

        // Volume bars if enabled
        if (showVolume) {
            const volTimes = volumeData.map(row => row[TIME_FROM_COL]);
            const volumes = volumeData.map(row => row[VOLUME_COL]);

            traces.push({
                x: volTimes,
                y: volumes,
                type: 'bar',
                name: 'Volume',
                marker: {color: '#636efa'},
                xaxis: 'x',
                yaxis: 'y2'
            });
        }

        // Fill points
        const activeFills = fills.filter((_, idx) => !deselectedFills.has(idx));

        if (COLOR_COLS.length > 0) {
            // Group by first color column
            const colorCol = COLOR_COLS[0];
            const fillsByColor = {};
            activeFills.forEach((fill, idx) => {
                const colorValue = String(fill[colorCol]);
                if (!fillsByColor[colorValue]) fillsByColor[colorValue] = [];
                fillsByColor[colorValue].push({fill, originalIdx: idx});
            });

            for (let colorValue in fillsByColor) {
                const items = fillsByColor[colorValue];
                const fillGroup = items.map(item => item.fill);
                const color = COLOR_MAPS[colorCol] && COLOR_MAPS[colorCol][colorValue] ?
                             COLOR_MAPS[colorCol][colorValue] :
                             COLOR_PALETTE[0];

                traces.push({
                    x: fillGroup.map(f => f[FILL_TIME_COL]),
                    y: fillGroup.map(f => f[PRICE_COL]),
                    type: 'scatter',
                    mode: 'markers',
                    name: colorValue,
                    marker: {
                        size: fillGroup.map(f => Math.max(5, 5 + Math.log(f[QUANTITY_COL] + 1) * 2)),
                        color: color
                    },
                    xaxis: 'x',
                    yaxis: 'y'
                });
            }
        } else {
            // No color grouping
            traces.push({
                x: activeFills.map(f => f[FILL_TIME_COL]),
                y: activeFills.map(f => f[PRICE_COL]),
                type: 'scatter',
                mode: 'markers',
                name: 'Fills',
                marker: {
                    size: activeFills.map(f => Math.max(5, 5 + Math.log(f[QUANTITY_COL] + 1) * 2)),
                    color: '#636efa'
                },
                xaxis: 'x',
                yaxis: 'y'
            });
        }

        // Calculate shortfall timeline
        const sideMultiplier = side === 'buy' ? 1 : -1;
        const shortfallTimes = [];
        const cumImpShortfalls = [];
        const cumVwapShortfalls = [];

        let cumImpShortfall = 0;
        let cumVwapShortfall = 0;

        fills.forEach((fill, idx) => {
            if (deselectedFills.has(idx)) return;

            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;

            cumImpShortfall += impShortfall;
            cumVwapShortfall += vwapShortfall;

            shortfallTimes.push(fill[FILL_TIME_COL]);
            cumImpShortfalls.push(cumImpShortfall);
            cumVwapShortfalls.push(cumVwapShortfall);
        });

        // Add shortfall timeline traces
        traces.push({
            x: shortfallTimes,
            y: cumImpShortfalls,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Imp. Shortfall',
            line: {color: '#FFA15A', width: 2},
            marker: {size: 6},
            xaxis: 'x',
            yaxis: 'y3',
            hovertemplate: 'Time: %{x}<br>Imp. Shortfall: %{y:.2f}<extra></extra>'
        });

        traces.push({
            x: shortfallTimes,
            y: cumVwapShortfalls,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'VWAP Shortfall',
            line: {color: '#ab63fa', width: 2},
            marker: {size: 6},
            xaxis: 'x',
            yaxis: 'y3',
            hovertemplate: 'Time: %{x}<br>VWAP Shortfall: %{y:.2f}<extra></extra>'
        });

        // Add zero reference line for shortfall chart
        if (shortfallTimes.length > 0) {
            traces.push({
                x: [shortfallTimes[0], shortfallTimes[shortfallTimes.length - 1]],
                y: [0, 0],
                type: 'scatter',
                mode: 'lines',
                name: 'Zero',
                line: {color: 'gray', width: 1, dash: 'dash'},
                xaxis: 'x',
                yaxis: 'y3',
                showlegend: false,
                hoverinfo: 'skip'
            });
        }

        // Adjust layout for three subplots
        const layout = {
            xaxis: {title: 'Time', anchor: showVolume ? 'y3' : 'y3'},
            yaxis: {
                title: 'Price',
                domain: showVolume ? [0.45, 1] : [0.35, 1]
            },
            yaxis3: {
                title: 'Cumulative Shortfall',
                domain: [0, showVolume ? 0.25 : 0.3],
                anchor: 'x'
            },
            hovermode: 'closest',
            showlegend: true
        };

        if (showVolume) {
            layout.yaxis2 = {
                title: 'Volume',
                domain: [0.3, 0.4],
                anchor: 'x'
            };
        }

        Plotly.newPlot('example3_exec', traces, layout, {responsive: true});
    }

    function calculateRollingVWAP(fills, upToIndex) {
        // Calculate VWAP for active fills up to and including upToIndex
        let totalValue = 0;
        let totalQty = 0;
        for (let i = 0; i <= upToIndex; i++) {
            if (!deselectedFills.has(i)) {
                const fill = fills[i];
                totalValue += fill[PRICE_COL] * fill[QUANTITY_COL];
                totalQty += fill[QUANTITY_COL];
            }
        }
        return totalQty > 0 ? totalValue / totalQty : 0;
    }

    function getSpreadCrossing(fill, side) {
        // Find the bid/ask at the fill time
        const fillTime = fill[FILL_TIME_COL];
        const tobAtFill = tobData.filter(row => row[TIME_COL] <= fillTime);
        if (tobAtFill.length === 0) return null;

        const lastTob = tobAtFill[tobAtFill.length - 1];
        const bid = lastTob[BID_COL];
        const ask = lastTob[ASK_COL];
        const spread = ask - bid;

        if (spread <= 0) return null;

        const fillPrice = fill[PRICE_COL];
        if (side === 'buy') {
            // 0 = bought at bid (neartouch), 1 = bought at ask (fartouch)
            return Math.max(0, Math.min(1, (fillPrice - bid) / spread));
        } else {
            // 0 = sold at ask (neartouch), 1 = sold at bid (fartouch)
            return Math.max(0, Math.min(1, (ask - fillPrice) / spread));
        }
    }

    function renderFillsTable(fills, benchmarkPrice, side, desiredQty) {
        const container = document.getElementById('fills_table_example3_exec');
        if (!container) return;

        let html = '<h4>Fill Details</h4>';
        html += '<table id="fills_table_content_example3_exec" style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Time</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Price</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>';
        COLOR_COLS.forEach(col => {
            html += `<th style="border: 1px solid #ddd; padding: 8px;">${col}</th>`;
        });
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Imp. Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">VWAP Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Spread Cross %</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Remaining %</th>';
        html += '</tr></thead><tbody>';

        let cumQty = 0;
        let cumImpShortfall = 0;
        let cumVwapShortfall = 0;

        fills.forEach((fill, idx) => {
            const isDeselected = deselectedFills.has(idx);
            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];
            const sideMultiplier = side === 'buy' ? 1 : -1;

            if (!isDeselected) {
                cumQty += qty;
            }

            const remaining = Math.max(0, (desiredQty - cumQty) / desiredQty * 100);

            // Calculate rolling VWAP up to this fill
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;
            const spreadCrossing = getSpreadCrossing(fill, side);

            if (!isDeselected) {
                cumImpShortfall += impShortfall;
                cumVwapShortfall += vwapShortfall;
            }

            const bgColor = isDeselected ? '#f0f0f0' : 'white';

            html += `<tr id="fill_row_${idx}_example3_exec"
                         style="background-color: ${bgColor}; cursor: pointer; transition: background-color 0.2s;"
                         onclick="toggleFill_example3_exec(${idx})"
                         onmouseover="highlightFill_example3_exec(${idx}, true)"
                         onmouseout="highlightFill_example3_exec(${idx}, false)">`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${fill[FILL_TIME_COL]}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${price.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${qty}</td>`;
            COLOR_COLS.forEach(col => {
                html += `<td style="border: 1px solid #ddd; padding: 8px;">${fill[col]}</td>`;
            });
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${cumImpShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${cumVwapShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${spreadCrossing !== null ? (spreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${remaining.toFixed(1)}%</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderSummaryTable(fills, benchmarkPrice, side, desiredQty) {
        const container = document.getElementById('summary_table_example3_exec');
        if (!container) return;

        // Get active fills only
        const activeFills = fills.filter((_, idx) => !deselectedFills.has(idx));

        let html = '<h4>Summary by Category</h4>';

        if (COLOR_COLS.length === 0) {
            // No color columns, just show overall summary
            html += '<p>No categories to aggregate by. Add color_cols for detailed breakdown.</p>';
            container.innerHTML = html;
            return;
        }

        // Use first color column for aggregation
        const colorCol = COLOR_COLS[0];
        const categories = {};

        const sideMultiplier = side === 'buy' ? 1 : -1;

        // Need to iterate through all fills (not just active) to get correct indices for rolling VWAP
        fills.forEach((fill, idx) => {
            if (deselectedFills.has(idx)) return; // Skip deselected fills

            const category = String(fill[colorCol]);
            if (!categories[category]) {
                categories[category] = {
                    totalImpShortfall: 0,
                    totalVwapShortfall: 0,
                    spreadCrossings: [],
                    count: 0,
                    totalQty: 0
                };
            }

            const qty = fill[QUANTITY_COL];
            const price = fill[PRICE_COL];

            // Use rolling VWAP up to this fill
            const rollingVWAP = calculateRollingVWAP(fills, idx);

            const impShortfall = sideMultiplier * (price - benchmarkPrice) * qty;
            const vwapShortfall = sideMultiplier * (price - rollingVWAP) * qty;
            const spreadCrossing = getSpreadCrossing(fill, side);

            categories[category].totalImpShortfall += impShortfall;
            categories[category].totalVwapShortfall += vwapShortfall;
            if (spreadCrossing !== null) {
                categories[category].spreadCrossings.push(spreadCrossing);
            }
            categories[category].count += 1;
            categories[category].totalQty += qty;
        });

        // Calculate overall totals
        let overallImpShortfall = 0;
        let overallVwapShortfall = 0;
        let overallSpreadCrossings = [];
        let overallCount = 0;
        let overallQty = 0;

        for (let cat in categories) {
            overallImpShortfall += categories[cat].totalImpShortfall;
            overallVwapShortfall += categories[cat].totalVwapShortfall;
            overallSpreadCrossings.push(...categories[cat].spreadCrossings);
            overallCount += categories[cat].count;
            overallQty += categories[cat].totalQty;
        }

        html += '<table style="width:100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += `<th style="border: 1px solid #ddd; padding: 8px;">${colorCol}</th>`;
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Fills</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Imp. Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">VWAP Shortfall</th>';
        html += '<th style="border: 1px solid #ddd; padding: 8px;">Avg Spread Cross %</th>';
        html += '</tr></thead><tbody>';

        // Sort categories alphabetically
        const sortedCategories = Object.keys(categories).sort();

        sortedCategories.forEach(category => {
            const data = categories[category];
            const avgSpreadCrossing = data.spreadCrossings.length > 0 ?
                data.spreadCrossings.reduce((a, b) => a + b, 0) / data.spreadCrossings.length : null;

            html += '<tr>';
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${category}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.count}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalQty}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalImpShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${data.totalVwapShortfall.toFixed(2)}</td>`;
            html += `<td style="border: 1px solid #ddd; padding: 8px;">${avgSpreadCrossing !== null ? (avgSpreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
            html += '</tr>';
        });

        // Add overall row
        const overallAvgSpreadCrossing = overallSpreadCrossings.length > 0 ?
            overallSpreadCrossings.reduce((a, b) => a + b, 0) / overallSpreadCrossings.length : null;

        html += '<tr style="font-weight: bold; background-color: #f9f9f9;">';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">Overall</td>';
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallCount}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallQty}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallImpShortfall.toFixed(2)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallVwapShortfall.toFixed(2)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${overallAvgSpreadCrossing !== null ? (overallAvgSpreadCrossing * 100).toFixed(1) + '%' : 'N/A'}</td>`;
        html += '</tr>';

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    window.toggleFill_example3_exec = function(idx) {
        if (deselectedFills.has(idx)) {
            deselectedFills.delete(idx);
        } else {
            deselectedFills.add(idx);
        }
        updateChart_example3_exec();
    };

    window.highlightFill_example3_exec = function(idx, isHighlighted) {
        // Get the chart element
        const chartDiv = document.getElementById('example3_exec');
        if (!chartDiv || !chartDiv.data) return;

        // Find which trace contains this fill
        const execSelect = document.getElementById('execution_select_example3_exec');
        const currentExecution = execSelect ? execSelect.value : 'Aggressive_Buy';
        const execFills = fillsData.filter(row => String(row[EXECUTION_NAME_COL]) === currentExecution);
        const fill = execFills[idx];
        if (!fill) return;

        // Find the trace and point index
        const fillTime = fill[FILL_TIME_COL];
        const fillPrice = fill[PRICE_COL];

        // Iterate through traces to find the matching fill point
        chartDiv.data.forEach((trace, traceIdx) => {
            if (trace.mode === 'markers' || trace.mode === 'markers+lines') {
                trace.x.forEach((x, pointIdx) => {
                    if (x === fillTime && Math.abs(trace.y[pointIdx] - fillPrice) < 0.01) {
                        // Found the point, update its marker
                        const update = {};
                        if (isHighlighted) {
                            // Increase size and add border
                            const currentSize = trace.marker.size[pointIdx] || trace.marker.size || 8;
                            update['marker.size'] = trace.marker.size.map((s, i) =>
                                i === pointIdx ? s * 1.5 : s
                            );
                            update['marker.line'] = {
                                color: 'black',
                                width: trace.marker.size.map((s, i) => i === pointIdx ? 2 : 0)
                            };
                        } else {
                            // Reset to original size
                            const originalSize = Math.max(5, 5 + Math.log(fill[QUANTITY_COL] + 1) * 2);
                            update['marker.size'] = trace.marker.size.map((s, i) =>
                                i === pointIdx ? originalSize : s
                            );
                            update['marker.line'] = {width: 0};
                        }
                        Plotly.restyle(chartDiv, update, [traceIdx]);
                    }
                });
            }
        });
    };

    // Load data
    Promise.all([
        loadDataset('tob_data3'),
        loadDataset('volume_data3'),
        loadDataset('fills_data3'),
        loadDataset('metadata3')
    ]).then(function([tob, vol, fills, metadata]) {
        tobData = tob;
        volumeData = vol;
        fillsData = fills;
        metadataData = metadata;

        updateChart_example3_exec();
    }).catch(function(error) {
        console.error('Error loading data for chart example3_exec:', error);
    });
})();


});
</script>

<!-- DATASETS -->

<script type="text/plain" id="volume_data3" data-format="csv_embedded" data-src="">
time_from,time_to,volume
2024-01-16T10:00:00.0,2024-01-16T10:02:00.0,191773
2024-01-16T10:02:00.0,2024-01-16T10:04:00.0,81150
2024-01-16T10:04:00.0,2024-01-16T10:06:00.0,84167
2024-01-16T10:06:00.0,2024-01-16T10:08:00.0,157236
2024-01-16T10:08:00.0,2024-01-16T10:10:00.0,85456
2024-01-16T10:10:00.0,2024-01-16T10:12:00.0,241939
2024-01-16T10:12:00.0,2024-01-16T10:14:00.0,206254
2024-01-16T10:14:00.0,2024-01-16T10:16:00.0,139693
2024-01-16T10:16:00.0,2024-01-16T10:18:00.0,139638
2024-01-16T10:18:00.0,2024-01-16T10:20:00.0,246598
2024-01-16T10:20:00.0,2024-01-16T10:22:00.0,240189
2024-01-16T10:22:00.0,2024-01-16T10:24:00.0,81589
2024-01-16T10:24:00.0,2024-01-16T10:26:00.0,203588
2024-01-16T10:26:00.0,2024-01-16T10:28:00.0,153537
2024-01-16T10:28:00.0,2024-01-16T10:30:00.0,110274
2024-01-16T10:30:00.0,2024-01-16T10:32:00.0,119755
2024-01-16T10:32:00.0,2024-01-16T10:34:00.0,86549
2024-01-16T10:34:00.0,2024-01-16T10:36:00.0,151262
2024-01-16T10:36:00.0,2024-01-16T10:38:00.0,128633
2024-01-16T10:38:00.0,2024-01-16T10:40:00.0,90882
2024-01-16T10:40:00.0,2024-01-16T10:42:00.0,172117
2024-01-16T10:42:00.0,2024-01-16T10:44:00.0,146911
2024-01-16T10:44:00.0,2024-01-16T10:46:00.0,235874
2024-01-16T10:46:00.0,2024-01-16T10:48:00.0,80089
2024-01-16T10:48:00.0,2024-01-16T10:50:00.0,234886
2024-01-16T10:50:00.0,2024-01-16T10:52:00.0,189346
2024-01-16T10:52:00.0,2024-01-16T10:54:00.0,204776
2024-01-16T10:54:00.0,2024-01-16T10:56:00.0,204689
2024-01-16T10:56:00.0,2024-01-16T10:58:00.0,205880
2024-01-16T10:58:00.0,2024-01-16T11:00:00.0,98354

</script><script type="text/plain" id="fills_data1" data-format="csv_embedded" data-src="">
time,quantity,price,execution_name,venue,aggressiveness
2024-01-15T09:39:13.0,300,150.00975912484247,Execution_1,BATS,Mid
2024-01-15T09:40:31.0,400,150.14897785829547,Execution_1,BATS,Passive
2024-01-15T09:40:38.0,500,150.13997785829548,Execution_1,NASDAQ,Aggressive
2024-01-15T09:41:00.0,350,150.15397785829546,Execution_1,ARCA,Mid
2024-01-15T09:41:46.0,450,150.1752010408337,Execution_1,BATS,Aggressive
2024-01-15T09:46:38.0,400,150.16141280079603,Execution_1,BATS,Passive
2024-01-15T09:47:19.0,350,150.09640461588558,Execution_1,NASDAQ,Aggressive
2024-01-15T09:47:43.0,500,150.0844003739778,Execution_1,ARCA,Aggressive
2024-01-15T09:48:04.0,400,150.12014771469998,Execution_1,ARCA,Mid
2024-01-15T09:48:35.0,350,150.14804641519734,Execution_1,ARCA,Passive
2024-01-15T09:49:24.0,450,150.16162704399423,Execution_1,BATS,Aggressive
2024-01-15T09:50:15.0,400,150.25291658337696,Execution_1,NYSE,Aggressive
2024-01-15T09:50:42.0,500,150.2913907400628,Execution_1,BATS,Passive
2024-01-15T09:52:52.0,350,150.30567093512383,Execution_1,ARCA,Aggressive
2024-01-15T09:53:03.0,400,150.28672201293804,Execution_1,BATS,Aggressive
2024-01-15T09:54:47.0,450,150.08117033004777,Execution_1,BATS,Mid
2024-01-15T09:55:57.0,350,150.04722320040642,Execution_1,NYSE,Passive
2024-01-15T09:59:25.0,500,150.26070998264498,Execution_1,NYSE,Aggressive
2024-01-15T10:05:54.0,400,150.10562441814446,Execution_1,ARCA,Mid
2024-01-15T10:06:27.0,350,150.1173888319077,Execution_1,NYSE,Mid
2024-01-15T10:07:24.0,450,150.14436557119137,Execution_1,NASDAQ,Mid
2024-01-15T10:10:12.0,400,149.95613009958421,Execution_1,NYSE,Passive
2024-01-15T10:10:38.0,500,149.92885437515324,Execution_1,NASDAQ,Aggressive
2024-01-15T10:14:37.0,350,149.99317777210268,Execution_1,BATS,Aggressive
2024-01-15T10:24:04.0,400,150.60265890742497,Execution_1,NYSE,Aggressive

</script><script type="text/plain" id="fills_data3" data-format="csv_embedded" data-src="">
time,quantity,price,execution_name,venue,urgency
2024-01-16T10:02:17.0,469,200.17541105178887,Aggressive_Buy,NASDAQ,High
2024-01-16T10:03:28.0,472,200.27601269446782,Aggressive_Buy,NYSE,High
2024-01-16T10:04:05.0,448,200.17473173927146,Aggressive_Buy,NASDAQ,High
2024-01-16T10:05:22.0,426,199.97907723602066,Aggressive_Buy,NYSE,High
2024-01-16T10:05:48.0,472,199.85911262770023,Aggressive_Buy,ARCA,High
2024-01-16T10:05:48.0,477,199.86511262770023,Aggressive_Buy,NYSE,High
2024-01-16T10:06:05.0,455,200.0126708394072,Aggressive_Buy,NYSE,High
2024-01-16T10:06:07.0,484,199.9996708394072,Aggressive_Buy,NYSE,High
2024-01-16T10:06:32.0,588,200.03427781609602,Aggressive_Buy,NASDAQ,High
2024-01-16T10:07:30.0,475,200.15010838736924,Aggressive_Buy,ARCA,High
2024-01-16T10:08:17.0,455,200.10955000863342,Aggressive_Buy,ARCA,High
2024-01-16T10:08:39.0,524,200.1000451661359,Aggressive_Buy,NASDAQ,High
2024-01-16T10:09:38.0,452,200.12051040984107,Aggressive_Buy,ARCA,High
2024-01-16T10:09:58.0,591,200.22683402531365,Aggressive_Buy,NASDAQ,High
2024-01-16T10:11:06.0,524,200.0326705901537,Aggressive_Buy,NYSE,High
2024-01-16T10:11:06.0,498,200.02167059015372,Aggressive_Buy,ARCA,High
2024-01-16T10:12:19.0,445,200.22351151263712,Aggressive_Buy,NYSE,High
2024-01-16T10:12:38.0,570,200.28137020917657,Aggressive_Buy,NYSE,High
2024-01-16T10:12:43.0,503,200.28437020917656,Aggressive_Buy,NASDAQ,High
2024-01-16T10:12:49.0,475,200.40471782428742,Aggressive_Buy,NYSE,High
2024-01-16T10:05:00.0,315,200.07466035974602,Patient_Buy,ARCA,Low
2024-01-16T10:06:11.0,349,199.9936708394072,Patient_Buy,NASDAQ,Low
2024-01-16T10:08:44.0,395,200.0860451661359,Patient_Buy,BATS,Low
2024-01-16T10:08:50.0,293,200.01004744540015,Patient_Buy,BATS,Low
2024-01-16T10:09:04.0,378,200.1561915450257,Patient_Buy,ARCA,Low
2024-01-16T10:11:56.0,346,200.10389479882465,Patient_Buy,BATS,Low
2024-01-16T10:12:30.0,375,200.2195115126371,Patient_Buy,NASDAQ,Low
2024-01-16T10:13:23.0,252,200.6166213633836,Patient_Buy,NYSE,Low
2024-01-16T10:13:59.0,270,200.65172460301426,Patient_Buy,NASDAQ,Low
2024-01-16T10:17:52.0,277,201.45672064298182,Patient_Buy,BATS,Low
2024-01-16T10:18:00.0,306,201.4597206429818,Patient_Buy,NYSE,Low
2024-01-16T10:18:46.0,271,201.68934183859017,Patient_Buy,BATS,Low
2024-01-16T10:19:38.0,400,201.81972500713482,Patient_Buy,NYSE,Low
2024-01-16T10:19:52.0,321,201.8543008615944,Patient_Buy,NASDAQ,Low
2024-01-16T10:21:58.0,346,202.05582294496836,Patient_Buy,NYSE,Low
2024-01-16T10:22:01.0,378,202.13521024274706,Patient_Buy,BATS,Low
2024-01-16T10:23:56.0,349,202.17610143570747,Patient_Buy,ARCA,Low
2024-01-16T10:25:27.0,250,202.0469076467355,Patient_Buy,BATS,Low
2024-01-16T10:25:43.0,322,201.95803263053193,Patient_Buy,NASDAQ,Low
2024-01-16T10:26:23.0,340,201.78969070648768,Patient_Buy,BATS,Low
2024-01-16T10:28:05.0,352,201.95491990271705,Patient_Buy,ARCA,Low
2024-01-16T10:28:16.0,272,201.9024981329834,Patient_Buy,BATS,Low
2024-01-16T10:28:59.0,280,201.7224078158071,Patient_Buy,NASDAQ,Low
2024-01-16T10:34:10.0,252,201.6448573050247,Patient_Buy,ARCA,Low
2024-01-16T10:34:39.0,279,201.66573639817923,Patient_Buy,NASDAQ,Low
2024-01-16T10:36:04.0,312,201.6086070190547,Patient_Buy,NASDAQ,Low
2024-01-16T10:36:39.0,331,201.48001071335378,Patient_Buy,NASDAQ,Low
2024-01-16T10:38:57.0,386,201.43287713983682,Patient_Buy,BATS,Low
2024-01-16T10:39:44.0,367,201.432632737897,Patient_Buy,NASDAQ,Low
2024-01-16T10:40:33.0,257,201.3596826372792,Patient_Buy,NYSE,Low
2024-01-16T10:43:38.0,360,201.6496347484681,Patient_Buy,NYSE,Low
2024-01-16T10:44:57.0,393,201.64020034950138,Patient_Buy,ARCA,Low
2024-01-16T10:52:37.0,311,201.86863109962252,Patient_Buy,NYSE,Low
2024-01-16T10:52:54.0,278,201.8390194914298,Patient_Buy,BATS,Low
2024-01-16T10:53:35.0,253,201.99700405710198,Patient_Buy,NYSE,Low

</script><script type="text/plain" id="metadata2" data-format="csv_embedded" data-src="">
execution_name,side,desired_quantity
Execution_2,sell,15000

</script><script type="text/plain" id="volume_data1" data-format="csv_embedded" data-src="">
time_from,time_to,volume
2024-01-15T09:30:00.0,2024-01-15T09:35:00.0,52268
2024-01-15T09:35:00.0,2024-01-15T09:40:00.0,142858
2024-01-15T09:40:00.0,2024-01-15T09:45:00.0,107574
2024-01-15T09:45:00.0,2024-01-15T09:50:00.0,177446
2024-01-15T09:50:00.0,2024-01-15T09:55:00.0,95315
2024-01-15T09:55:00.0,2024-01-15T10:00:00.0,179936
2024-01-15T10:00:00.0,2024-01-15T10:05:00.0,116628
2024-01-15T10:05:00.0,2024-01-15T10:10:00.0,128137
2024-01-15T10:10:00.0,2024-01-15T10:15:00.0,122754
2024-01-15T10:15:00.0,2024-01-15T10:20:00.0,73151
2024-01-15T10:20:00.0,2024-01-15T10:25:00.0,164954

</script><script type="text/plain" id="fills_data2" data-format="csv_embedded" data-src="">
time,quantity,price,execution_name,strategy,fill_type
2024-01-15T14:03:21.0,201,75.11139321812331,Execution_2,Opportunistic,Limit
2024-01-15T14:03:44.0,442,75.09809868279848,Execution_2,TWAP,Market
2024-01-15T14:04:19.0,560,75.09773788595761,Execution_2,TWAP,Peg
2024-01-15T14:09:09.0,247,74.88536953890346,Execution_2,POV,Peg
2024-01-15T14:10:37.0,586,74.86858154966396,Execution_2,Opportunistic,Limit
2024-01-15T14:10:57.0,217,74.81322044657624,Execution_2,TWAP,Peg
2024-01-15T14:11:15.0,295,74.84568115097122,Execution_2,VWAP,Limit
2024-01-15T14:11:33.0,433,74.8752594507403,Execution_2,Opportunistic,Limit
2024-01-15T14:21:06.0,526,75.06099385248862,Execution_2,VWAP,Peg
2024-01-15T14:21:26.0,274,75.08031513865386,Execution_2,POV,Limit
2024-01-15T14:22:54.0,348,75.13916217078697,Execution_2,POV,Market
2024-01-15T14:28:13.0,528,75.15093286124292,Execution_2,VWAP,Limit
2024-01-15T14:28:16.0,347,75.15793286124291,Execution_2,POV,Peg
2024-01-15T14:29:03.0,346,75.21159515095155,Execution_2,POV,Limit
2024-01-15T14:30:57.0,432,75.20412737224143,Execution_2,POV,Peg
2024-01-15T14:31:03.0,225,75.23828951154304,Execution_2,TWAP,Limit
2024-01-15T14:34:12.0,508,75.32863336104089,Execution_2,TWAP,Peg
2024-01-15T14:35:02.0,479,75.33057593908333,Execution_2,Opportunistic,Limit
2024-01-15T14:36:33.0,298,75.19513059050065,Execution_2,POV,Peg
2024-01-15T14:38:01.0,534,75.12744162159171,Execution_2,VWAP,Limit
2024-01-15T14:42:33.0,294,75.13750589612177,Execution_2,POV,Peg
2024-01-15T14:43:56.0,397,75.25637032142824,Execution_2,Opportunistic,Market
2024-01-15T14:45:15.0,387,75.22821154529252,Execution_2,VWAP,Peg
2024-01-15T14:46:55.0,203,75.08166562088981,Execution_2,TWAP,Peg
2024-01-15T14:48:29.0,595,75.02301232620532,Execution_2,POV,Peg
2024-01-15T14:48:53.0,504,75.04567168039145,Execution_2,TWAP,Peg
2024-01-15T14:51:46.0,311,75.088658305082,Execution_2,POV,Market
2024-01-15T14:53:02.0,545,75.02587410507569,Execution_2,Opportunistic,Limit
2024-01-15T14:54:59.0,399,74.99311677733887,Execution_2,Opportunistic,Market
2024-01-15T14:56:33.0,473,74.93373932944706,Execution_2,Opportunistic,Peg

</script><script type="text/plain" id="metadata1" data-format="csv_embedded" data-src="">
execution_name,arrival_price,side,desired_quantity
Execution_1,150.0,buy,10000

</script><script type="text/plain" id="metadata3" data-format="csv_embedded" data-src="">
execution_name,arrival_price,side,desired_quantity
Aggressive_Buy,200.0,buy,10000
Patient_Buy,200.0,buy,12000

</script><script type="text/plain" id="tob_data1" data-format="csv_embedded" data-src="">
time,bid,ask
2024-01-15T09:30:00.0,149.9707340733185,149.9907340733185
2024-01-15T09:30:30.0,150.02024333423816,150.04024333423814
2024-01-15T09:31:00.0,150.00370063263745,150.02370063263743
2024-01-15T09:31:30.0,150.0651744930174,150.08517449301738
2024-01-15T09:32:00.0,150.0323299193527,150.05232991935267
2024-01-15T09:32:30.0,150.01765761735055,150.03765761735053
2024-01-15T09:33:00.0,149.93773698381153,149.95773698381151
2024-01-15T09:33:30.0,149.94583589373948,149.96583589373947
2024-01-15T09:34:00.0,149.93126397647498,149.95126397647496
2024-01-15T09:34:30.0,149.9387912732695,149.95879127326947
2024-01-15T09:35:00.0,149.97814481012722,149.9981448101272
2024-01-15T09:35:30.0,149.95088082943187,149.97088082943185
2024-01-15T09:36:00.0,150.01526595439336,150.03526595439334
2024-01-15T09:36:30.0,150.06094180199597,150.08094180199595
2024-01-15T09:37:00.0,150.0532092838915,150.0732092838915
2024-01-15T09:37:30.0,150.0309440567082,150.05094405670818
2024-01-15T09:38:00.0,149.95871748522168,149.97871748522167
2024-01-15T09:38:30.0,149.92994058961028,149.94994058961026
2024-01-15T09:39:00.0,149.9746221731079,149.99462217310787
2024-01-15T09:39:30.0,149.99275912484248,150.01275912484246
2024-01-15T09:40:00.0,149.9757595156387,149.9957595156387
2024-01-15T09:40:30.0,150.0274366492015,150.04743664920147
2024-01-15T09:41:00.0,150.1239778582955,150.14397785829547
2024-01-15T09:41:30.0,150.15012375899036,150.17012375899034
2024-01-15T09:42:00.0,150.16320104083374,150.18320104083372
2024-01-15T09:42:30.0,150.18868759744046,150.20868759744044
2024-01-15T09:43:00.0,150.23549096922372,150.2554909692237
2024-01-15T09:43:30.0,150.212126102072,150.232126102072
2024-01-15T09:44:00.0,150.20640692020126,150.22640692020124
2024-01-15T09:44:30.0,150.23177634634442,150.2517763463444
2024-01-15T09:45:00.0,150.22373277837346,150.24373277837344
2024-01-15T09:45:30.0,150.18691610394416,150.20691610394414
2024-01-15T09:46:00.0,150.18290874285265,150.20290874285263
2024-01-15T09:46:30.0,150.14672870345103,150.166728703451
2024-01-15T09:47:00.0,150.14841280079605,150.16841280079603
2024-01-15T09:47:30.0,150.0704046158856,150.09040461588557
2024-01-15T09:48:00.0,150.0724003739778,150.0924003739778
2024-01-15T09:48:30.0,150.0911477147,150.1111477147
2024-01-15T09:49:00.0,150.13004641519737,150.15004641519735
2024-01-15T09:49:30.0,150.13662704399425,150.15662704399423
2024-01-15T09:50:00.0,150.27585661820447,150.29585661820445
2024-01-15T09:50:30.0,150.22691658337698,150.24691658337696
2024-01-15T09:51:00.0,150.26939074006282,150.2893907400628
2024-01-15T09:51:30.0,150.2275620213372,150.2475620213372
2024-01-15T09:52:00.0,150.27269954620422,150.2926995462042
2024-01-15T09:52:30.0,150.30725982959933,150.3272598295993
2024-01-15T09:53:00.0,150.27967093512385,150.29967093512383
2024-01-15T09:53:30.0,150.26872201293807,150.28872201293805
2024-01-15T09:54:00.0,150.20627353222105,150.22627353222103
2024-01-15T09:54:30.0,150.10964228984835,150.12964228984833
2024-01-15T09:55:00.0,150.06017033004778,150.08017033004776
2024-01-15T09:55:30.0,150.01627385149095,150.03627385149093
2024-01-15T09:56:00.0,150.03622320040643,150.0562232004064
2024-01-15T09:56:30.0,150.06492684531275,150.08492684531274
2024-01-15T09:57:00.0,150.14687481693818,150.16687481693816
2024-01-15T09:57:30.0,150.22828620139404,150.24828620139402
2024-01-15T09:58:00.0,150.24766835802606,150.26766835802604
2024-01-15T09:58:30.0,150.32386954536526,150.34386954536524
2024-01-15T09:59:00.0,150.23423943896486,150.25423943896485
2024-01-15T09:59:30.0,150.239709982645,150.25970998264498
2024-01-15T10:00:00.0,150.26158440627043,150.2815844062704
2024-01-15T10:00:30.0,150.19640565069776,150.21640565069774
2024-01-15T10:01:00.0,150.1117579839474,150.13175798394738
2024-01-15T10:01:30.0,150.07706984379533,150.0970698437953
2024-01-15T10:02:00.0,150.05489056697505,150.07489056697503
2024-01-15T10:02:30.0,150.11355903140566,150.13355903140564
2024-01-15T10:03:00.0,150.10819307305295,150.12819307305293
2024-01-15T10:03:30.0,150.14823163006125,150.16823163006123
2024-01-15T10:04:00.0,150.12136278716235,150.14136278716234
2024-01-15T10:04:30.0,150.10205236680181,150.1220523668018
2024-01-15T10:05:00.0,150.0412492006049,150.0612492006049
2024-01-15T10:05:30.0,150.0349536233439,150.0549536233439
2024-01-15T10:06:00.0,150.07762441814447,150.09762441814445
2024-01-15T10:06:30.0,150.09438883190774,150.11438883190772
2024-01-15T10:07:00.0,150.10476178376194,150.12476178376193
2024-01-15T10:07:30.0,150.11636557119138,150.13636557119136
2024-01-15T10:08:00.0,150.10954340679237,150.12954340679235
2024-01-15T10:08:30.0,149.98817926860727,150.00817926860725
2024-01-15T10:09:00.0,150.01469786306677,150.03469786306675
2024-01-15T10:09:30.0,150.0143625698656,150.03436256986558
2024-01-15T10:10:00.0,149.8880497971255,149.90804979712547
2024-01-15T10:10:30.0,149.93913009958422,149.9591300995842
2024-01-15T10:11:00.0,149.91785437515324,149.93785437515322
2024-01-15T10:11:30.0,149.9707549726832,149.9907549726832
2024-01-15T10:12:00.0,149.94312465737946,149.96312465737944
2024-01-15T10:12:30.0,149.96494862941935,149.98494862941934
2024-01-15T10:13:00.0,149.97467511646124,149.99467511646122
2024-01-15T10:13:30.0,149.99450080392364,150.01450080392362
2024-01-15T10:14:00.0,149.98188767700998,150.00188767700996
2024-01-15T10:14:30.0,149.95064137301637,149.97064137301635
2024-01-15T10:15:00.0,149.9651777721027,149.98517777210267
2024-01-15T10:15:30.0,150.02706781945676,150.04706781945674
2024-01-15T10:16:00.0,150.0377360098287,150.0577360098287
2024-01-15T10:16:30.0,150.05337279386157,150.07337279386155
2024-01-15T10:17:00.0,150.0879030693474,150.10790306934737
2024-01-15T10:17:30.0,150.07229581354238,150.09229581354236
2024-01-15T10:18:00.0,150.07952958959217,150.09952958959215
2024-01-15T10:18:30.0,150.07529315198647,150.09529315198645
2024-01-15T10:19:00.0,150.07056623071463,150.09056623071461
2024-01-15T10:19:30.0,150.11504852576888,150.13504852576887
2024-01-15T10:20:00.0,150.12321152122138,150.14321152122136
2024-01-15T10:20:30.0,150.23375496448224,150.25375496448223
2024-01-15T10:21:00.0,150.26894717961318,150.28894717961316
2024-01-15T10:21:30.0,150.29505443328193,150.31505443328192
2024-01-15T10:22:00.0,150.3072166108549,150.3272166108549
2024-01-15T10:22:30.0,150.2746211005571,150.2946211005571
2024-01-15T10:23:00.0,150.41105797552962,150.4310579755296
2024-01-15T10:23:30.0,150.45840732790768,150.47840732790766
2024-01-15T10:24:00.0,150.52039712233395,150.54039712233393
2024-01-15T10:24:30.0,150.58765890742498,150.60765890742496
2024-01-15T10:25:00.0,150.6573838556628,150.67738385566278
2024-01-15T10:25:30.0,150.54876208231948,150.56876208231947
2024-01-15T10:26:00.0,150.5582110282969,150.5782110282969
2024-01-15T10:26:30.0,150.5569588552024,150.57695885520238
2024-01-15T10:27:00.0,150.5066315634266,150.52663156342658
2024-01-15T10:27:30.0,150.50266179564966,150.52266179564964
2024-01-15T10:28:00.0,150.55204384038404,150.57204384038403
2024-01-15T10:28:30.0,150.55687406381708,150.57687406381706
2024-01-15T10:29:00.0,150.5897869272996,150.60978692729958
2024-01-15T10:29:30.0,150.61061232732288,150.63061232732286
2024-01-15T10:30:00.0,150.57635658064544,150.59635658064542

</script><script type="text/plain" id="tob_data2" data-format="csv_embedded" data-src="">
time,bid,ask
2024-01-15T14:00:00.0,74.94472427513081,74.9597242751308
2024-01-15T14:00:20.0,74.98722416090179,75.00222416090178
2024-01-15T14:00:40.0,74.9636808147069,74.97868081470689
2024-01-15T14:01:00.0,74.97615817030633,74.99115817030632
2024-01-15T14:01:20.0,75.01520814018616,75.03020814018615
2024-01-15T14:01:40.0,75.00142968339884,75.01642968339883
2024-01-15T14:02:00.0,74.98271294867689,74.99771294867688
2024-01-15T14:02:20.0,74.96751126987954,74.98251126987952
2024-01-15T14:02:40.0,75.0323464472682,75.04734644726818
2024-01-15T14:03:00.0,75.08748654326938,75.10248654326936
2024-01-15T14:03:20.0,75.08792969890658,75.10292969890656
2024-01-15T14:03:40.0,75.11139321812331,75.1263932181233
2024-01-15T14:04:00.0,75.09209868279848,75.10709868279847
2024-01-15T14:04:20.0,75.09173788595761,75.1067378859576
2024-01-15T14:04:40.0,75.0892919141384,75.10429191413839
2024-01-15T14:05:00.0,75.08909888804335,75.10409888804334
2024-01-15T14:05:20.0,74.9963387211512,75.01133872115119
2024-01-15T14:05:40.0,74.99630032565,75.01130032564998
2024-01-15T14:06:00.0,75.00429821398556,75.01929821398555
2024-01-15T14:06:20.0,75.01309356026077,75.02809356026076
2024-01-15T14:06:40.0,75.04365296519386,75.05865296519384
2024-01-15T14:07:00.0,75.0169940159293,75.03199401592929
2024-01-15T14:07:20.0,75.00288169831573,75.01788169831572
2024-01-15T14:07:40.0,74.98452823822637,74.99952823822636
2024-01-15T14:08:00.0,74.92526609483032,74.9402660948303
2024-01-15T14:08:20.0,74.92829492230324,74.94329492230322
2024-01-15T14:08:40.0,74.91451632480457,74.92951632480455
2024-01-15T14:09:00.0,74.93427976116902,74.94927976116901
2024-01-15T14:09:20.0,74.88936953890347,74.90436953890345
2024-01-15T14:09:40.0,74.93020461127614,74.94520461127613
2024-01-15T14:10:00.0,74.90049930007729,74.91549930007727
2024-01-15T14:10:20.0,74.86988482153251,74.8848848215325
2024-01-15T14:10:40.0,74.86558154966396,74.88058154966394
2024-01-15T14:11:00.0,74.80722044657624,74.82222044657622
2024-01-15T14:11:20.0,74.83668115097122,74.8516811509712
2024-01-15T14:11:40.0,74.8732594507403,74.88825945074029
2024-01-15T14:12:00.0,74.90040870688568,74.91540870688567
2024-01-15T14:12:20.0,74.86978393682794,74.88478393682793
2024-01-15T14:12:40.0,74.90435173683042,74.91935173683041
2024-01-15T14:13:00.0,74.90643771240322,74.9214377124032
2024-01-15T14:13:20.0,74.9440274472047,74.95902744720469
2024-01-15T14:13:40.0,74.9353411396669,74.95034113966689
2024-01-15T14:14:00.0,74.94773740002512,74.9627374000251
2024-01-15T14:14:20.0,74.95840974492322,74.9734097449232
2024-01-15T14:14:40.0,74.95734228247947,74.97234228247946
2024-01-15T14:15:00.0,74.98226935754376,74.99726935754374
2024-01-15T14:15:20.0,74.99194285681084,75.00694285681082
2024-01-15T14:15:40.0,74.95373896433165,74.96873896433164
2024-01-15T14:16:00.0,74.95494476093583,74.96994476093582
2024-01-15T14:16:20.0,75.00030142594714,75.01530142594713
2024-01-15T14:16:40.0,74.99303542527038,75.00803542527036
2024-01-15T14:17:00.0,74.97675211281519,74.99175211281518
2024-01-15T14:17:20.0,74.99279602257083,75.00779602257082
2024-01-15T14:17:40.0,74.99563559234025,75.01063559234024
2024-01-15T14:18:00.0,75.00311935805297,75.01811935805296
2024-01-15T14:18:20.0,75.00444886033938,75.01944886033937
2024-01-15T14:18:40.0,75.01756338523928,75.03256338523927
2024-01-15T14:19:00.0,75.03262804704711,75.0476280470471
2024-01-15T14:19:20.0,75.00879361800948,75.02379361800946
2024-01-15T14:19:40.0,74.97850236286273,74.99350236286271
2024-01-15T14:20:00.0,75.04366832616401,75.058668326164
2024-01-15T14:20:20.0,75.04101229487509,75.05601229487507
2024-01-15T14:20:40.0,75.07948513783398,75.09448513783397
2024-01-15T14:21:00.0,75.08551872771444,75.10051872771443
2024-01-15T14:21:20.0,75.05899385248863,75.07399385248861
2024-01-15T14:21:40.0,75.07931513865385,75.09431513865384
2024-01-15T14:22:00.0,75.09703983128384,75.11203983128382
2024-01-15T14:22:20.0,75.16296147036597,75.17796147036596
2024-01-15T14:22:40.0,75.16174518827349,75.17674518827347
2024-01-15T14:23:00.0,75.13916217078697,75.15416217078696
2024-01-15T14:23:20.0,75.1193491186643,75.13434911866429
2024-01-15T14:23:40.0,75.13244721325154,75.14744721325152
2024-01-15T14:24:00.0,75.11504410088959,75.13004410088958
2024-01-15T14:24:20.0,75.0744676558531,75.08946765585308
2024-01-15T14:24:40.0,75.05710061114169,75.07210061114168
2024-01-15T14:25:00.0,75.07726036324729,75.09226036324728
2024-01-15T14:25:20.0,75.02155887202483,75.03655887202481
2024-01-15T14:25:40.0,75.0315227783739,75.04652277837388
2024-01-15T14:26:00.0,75.09944536911611,75.1144453691161
2024-01-15T14:26:20.0,75.04521560823834,75.06021560823832
2024-01-15T14:26:40.0,75.06020938204702,75.075209382047
2024-01-15T14:27:00.0,75.0536367859952,75.06863678599518
2024-01-15T14:27:20.0,75.07703184389324,75.09203184389322
2024-01-15T14:27:40.0,75.06836831907926,75.08336831907924
2024-01-15T14:28:00.0,75.09602053536796,75.11102053536794
2024-01-15T14:28:20.0,75.14993286124292,75.1649328612429
2024-01-15T14:28:40.0,75.16224305570606,75.17724305570604
2024-01-15T14:29:00.0,75.16779949286804,75.18279949286803
2024-01-15T14:29:20.0,75.20459515095155,75.21959515095153
2024-01-15T14:29:40.0,75.16380200948691,75.1788020094869
2024-01-15T14:30:00.0,75.17135759035205,75.18635759035203
2024-01-15T14:30:20.0,75.19180114992156,75.20680114992155
2024-01-15T14:30:40.0,75.21999236701434,75.23499236701433
2024-01-15T14:31:00.0,75.19412737224143,75.20912737224141
2024-01-15T14:31:20.0,75.23628951154305,75.25128951154304
2024-01-15T14:31:40.0,75.22074539073735,75.23574539073734
2024-01-15T14:32:00.0,75.23137232444648,75.24637232444647
2024-01-15T14:32:20.0,75.25766531145321,75.2726653114532
2024-01-15T14:32:40.0,75.25946497547072,75.2744649754707
2024-01-15T14:33:00.0,75.26938784654682,75.2843878465468
2024-01-15T14:33:20.0,75.30522906685908,75.32022906685907
2024-01-15T14:33:40.0,75.28307250552018,75.29807250552017
2024-01-15T14:34:00.0,75.29506023134152,75.31006023134151
2024-01-15T14:34:20.0,75.33063336104088,75.34563336104087
2024-01-15T14:34:40.0,75.29477219855428,75.30977219855427
2024-01-15T14:35:00.0,75.33467953525678,75.34967953525677
2024-01-15T14:35:20.0,75.33357593908333,75.34857593908332
2024-01-15T14:35:40.0,75.28757584406232,75.3025758440623
2024-01-15T14:36:00.0,75.2389451700804,75.25394517008039
2024-01-15T14:36:20.0,75.20280415482355,75.21780415482354
2024-01-15T14:36:40.0,75.19313059050066,75.20813059050064
2024-01-15T14:37:00.0,75.19060362189414,75.20560362189413
2024-01-15T14:37:20.0,75.174825108494,75.18982510849399
2024-01-15T14:37:40.0,75.15072697222384,75.16572697222382
2024-01-15T14:38:00.0,75.1869782259812,75.2019782259812
2024-01-15T14:38:20.0,75.13144162159172,75.1464416215917
2024-01-15T14:38:40.0,75.19285125900429,75.20785125900427
2024-01-15T14:39:00.0,75.21267774318684,75.22767774318683
2024-01-15T14:39:20.0,75.18655733883466,75.20155733883465
2024-01-15T14:39:40.0,75.18668163274539,75.20168163274538
2024-01-15T14:40:00.0,75.16489833099604,75.17989833099602
2024-01-15T14:40:20.0,75.1827745667864,75.19777456678639
2024-01-15T14:40:40.0,75.18511698879462,75.2001169887946
2024-01-15T14:41:00.0,75.1776289894139,75.19262898941389
2024-01-15T14:41:20.0,75.18388968400455,75.19888968400454
2024-01-15T14:41:40.0,75.19055185443408,75.20555185443406
2024-01-15T14:42:00.0,75.16193097981062,75.1769309798106
2024-01-15T14:42:20.0,75.1736882443154,75.18868824431539
2024-01-15T14:42:40.0,75.13850589612177,75.15350589612176
2024-01-15T14:43:00.0,75.1837473415614,75.19874734156139
2024-01-15T14:43:20.0,75.19308686145494,75.20808686145493
2024-01-15T14:43:40.0,75.23241740822886,75.24741740822884
2024-01-15T14:44:00.0,75.25137032142824,75.26637032142823
2024-01-15T14:44:20.0,75.25940780332094,75.27440780332093
2024-01-15T14:44:40.0,75.22709228001723,75.24209228001722
2024-01-15T14:45:00.0,75.24999304853343,75.26499304853341
2024-01-15T14:45:20.0,75.22521154529252,75.24021154529251
2024-01-15T14:45:40.0,75.22237277647393,75.23737277647392
2024-01-15T14:46:00.0,75.20851257017151,75.2235125701715
2024-01-15T14:46:20.0,75.16379393206729,75.17879393206728
2024-01-15T14:46:40.0,75.11775235727391,75.1327523572739
2024-01-15T14:47:00.0,75.08466562088981,75.0996656208898
2024-01-15T14:47:20.0,75.0706989779895,75.08569897798948
2024-01-15T14:47:40.0,75.05120568715856,75.06620568715854
2024-01-15T14:48:00.0,74.99485439722866,75.00985439722865
2024-01-15T14:48:20.0,74.99611196908593,75.01111196908592
2024-01-15T14:48:40.0,75.01601232620531,75.0310123262053
2024-01-15T14:49:00.0,75.03767168039145,75.05267168039144
2024-01-15T14:49:20.0,75.04269324814851,75.0576932481485
2024-01-15T14:49:40.0,75.05518110765252,75.0701811076525
2024-01-15T14:50:00.0,75.06986324999308,75.08486324999306
2024-01-15T14:50:20.0,75.05406002985887,75.06906002985886
2024-01-15T14:50:40.0,75.01691736273258,75.03191736273257
2024-01-15T14:51:00.0,75.06080563572445,75.07580563572444
2024-01-15T14:51:20.0,75.04082205920135,75.05582205920133
2024-01-15T14:51:40.0,75.07127913207822,75.0862791320782
2024-01-15T14:52:00.0,75.093658305082,75.10865830508199
2024-01-15T14:52:20.0,75.05741094492106,75.07241094492105
2024-01-15T14:52:40.0,75.07400365908063,75.08900365908062
2024-01-15T14:53:00.0,75.04100908750955,75.05600908750954
2024-01-15T14:53:20.0,75.02387410507569,75.03887410507568
2024-01-15T14:53:40.0,74.98093114266216,74.99593114266214
2024-01-15T14:54:00.0,74.99884611184791,75.0138461118479
2024-01-15T14:54:20.0,75.03323155572028,75.04823155572026
2024-01-15T14:54:40.0,74.9737553544266,74.98875535442659
2024-01-15T14:55:00.0,74.98511677733887,75.00011677733886
2024-01-15T14:55:20.0,74.97028776418497,74.98528776418496
2024-01-15T14:55:40.0,74.97114011298456,74.98614011298454
2024-01-15T14:56:00.0,74.96580324461479,74.98080324461478
2024-01-15T14:56:20.0,74.9512328009151,74.96623280091508
2024-01-15T14:56:40.0,74.92873932944707,74.94373932944706
2024-01-15T14:57:00.0,74.93406899506557,74.94906899506556
2024-01-15T14:57:20.0,74.92560882406607,74.94060882406606
2024-01-15T14:57:40.0,74.91006402124414,74.92506402124413
2024-01-15T14:58:00.0,74.86527908803842,74.8802790880384
2024-01-15T14:58:20.0,74.83174716848654,74.84674716848653
2024-01-15T14:58:40.0,74.79124344214544,74.80624344214543
2024-01-15T14:59:00.0,74.82389858529866,74.83889858529865
2024-01-15T14:59:20.0,74.8180453047643,74.83304530476428
2024-01-15T14:59:40.0,74.84123185452964,74.85623185452963
2024-01-15T15:00:00.0,74.853948348101,74.86894834810099

</script><script type="text/plain" id="volume_data2" data-format="csv_embedded" data-src="">
time_from,time_to,volume
2024-01-15T14:00:00.0,2024-01-15T14:03:00.0,31554
2024-01-15T14:03:00.0,2024-01-15T14:06:00.0,112152
2024-01-15T14:06:00.0,2024-01-15T14:09:00.0,125774
2024-01-15T14:09:00.0,2024-01-15T14:12:00.0,63811
2024-01-15T14:12:00.0,2024-01-15T14:15:00.0,76251
2024-01-15T14:15:00.0,2024-01-15T14:18:00.0,111671
2024-01-15T14:18:00.0,2024-01-15T14:21:00.0,51625
2024-01-15T14:21:00.0,2024-01-15T14:24:00.0,36062
2024-01-15T14:24:00.0,2024-01-15T14:27:00.0,43567
2024-01-15T14:27:00.0,2024-01-15T14:30:00.0,129620
2024-01-15T14:30:00.0,2024-01-15T14:33:00.0,105445
2024-01-15T14:33:00.0,2024-01-15T14:36:00.0,106467
2024-01-15T14:36:00.0,2024-01-15T14:39:00.0,144949
2024-01-15T14:39:00.0,2024-01-15T14:42:00.0,51920
2024-01-15T14:42:00.0,2024-01-15T14:45:00.0,113387
2024-01-15T14:45:00.0,2024-01-15T14:48:00.0,65660
2024-01-15T14:48:00.0,2024-01-15T14:51:00.0,117385
2024-01-15T14:51:00.0,2024-01-15T14:54:00.0,113708
2024-01-15T14:54:00.0,2024-01-15T14:57:00.0,143491
2024-01-15T14:57:00.0,2024-01-15T15:00:00.0,120122

</script><script type="text/plain" id="tob_data3" data-format="csv_embedded" data-src="">
time,bid,ask
2024-01-16T10:00:00.0,199.8826951879389,199.90769518793888
2024-01-16T10:00:15.0,200.00814062299372,200.0331406229937
2024-01-16T10:00:30.0,200.0330000576933,200.05800005769328
2024-01-16T10:00:45.0,200.03975449744777,200.06475449744775
2024-01-16T10:01:00.0,200.07459175565666,200.09959175565663
2024-01-16T10:01:15.0,200.0096668302337,200.03466683023368
2024-01-16T10:01:30.0,200.17925187860232,200.2042518786023
2024-01-16T10:01:45.0,200.10357177945602,200.128571779456
2024-01-16T10:02:00.0,200.23484295333083,200.2598429533308
2024-01-16T10:02:15.0,200.17611758756897,200.20111758756894
2024-01-16T10:02:30.0,200.1504110517889,200.17541105178887
2024-01-16T10:02:45.0,200.21093930981164,200.2359393098116
2024-01-16T10:03:00.0,200.2780752162256,200.30307521622558
2024-01-16T10:03:15.0,200.21982537477402,200.244825374774
2024-01-16T10:03:30.0,200.23201269446784,200.25701269446782
2024-01-16T10:03:45.0,200.22603136656548,200.25103136656546
2024-01-16T10:04:00.0,200.13309717407066,200.15809717407063
2024-01-16T10:04:15.0,200.1447317392715,200.16973173927147
2024-01-16T10:04:30.0,200.20627040743713,200.2312704074371
2024-01-16T10:04:45.0,200.14597657407342,200.1709765740734
2024-01-16T10:05:00.0,200.05366035974603,200.078660359746
2024-01-16T10:05:15.0,199.9474373699619,199.97243736996188
2024-01-16T10:05:30.0,199.94007723602067,199.96507723602065
2024-01-16T10:05:45.0,199.9561502126732,199.98115021267319
2024-01-16T10:06:00.0,199.82111262770024,199.84611262770022
2024-01-16T10:06:15.0,199.97067083940723,199.9956708394072
2024-01-16T10:06:30.0,199.97072498323254,199.99572498323252
2024-01-16T10:06:45.0,200.00627781609606,200.03127781609604
2024-01-16T10:07:00.0,200.06036112732468,200.08536112732466
2024-01-16T10:07:15.0,200.1138881413434,200.1388881413434
2024-01-16T10:07:30.0,200.11710838736926,200.14210838736923
2024-01-16T10:07:45.0,200.18430667381065,200.20930667381063
2024-01-16T10:08:00.0,200.15055303582395,200.17555303582392
2024-01-16T10:08:15.0,200.02066326165897,200.04566326165894
2024-01-16T10:08:30.0,200.06755000863345,200.09255000863342
2024-01-16T10:08:45.0,200.07404516613593,200.0990451661359
2024-01-16T10:09:00.0,199.98504744540017,200.01004744540015
2024-01-16T10:09:15.0,200.13619154502572,200.1611915450257
2024-01-16T10:09:30.0,200.16555265516675,200.19055265516673
2024-01-16T10:09:45.0,200.0945104098411,200.11951040984107
2024-01-16T10:10:00.0,200.1868340253137,200.21183402531366
2024-01-16T10:10:15.0,200.1054095894804,200.13040958948037
2024-01-16T10:10:30.0,200.06305062675202,200.088050626752
2024-01-16T10:10:45.0,199.92786797905396,199.95286797905393
2024-01-16T10:11:00.0,199.99695874146582,200.0219587414658
2024-01-16T10:11:15.0,199.99467059015373,200.0196705901537
2024-01-16T10:11:30.0,200.02660922616673,200.0516092261667
2024-01-16T10:11:45.0,200.1571417456188,200.18214174561876
2024-01-16T10:12:00.0,200.08989479882467,200.11489479882465
2024-01-16T10:12:15.0,200.22002544261142,200.2450254426114
2024-01-16T10:12:30.0,200.19651151263713,200.2215115126371
2024-01-16T10:12:45.0,200.24837020917658,200.27337020917656
2024-01-16T10:13:00.0,200.36871782428744,200.39371782428742
2024-01-16T10:13:15.0,200.4458062486844,200.47080624868437
2024-01-16T10:13:30.0,200.6006213633836,200.62562136338357
2024-01-16T10:13:45.0,200.5487251024349,200.57372510243488
2024-01-16T10:14:00.0,200.62972460301427,200.65472460301424
2024-01-16T10:14:15.0,200.65043127842625,200.67543127842623
2024-01-16T10:14:30.0,200.57145797738886,200.59645797738884
2024-01-16T10:14:45.0,200.614406068516,200.63940606851597
2024-01-16T10:15:00.0,200.72029662873993,200.7452966287399
2024-01-16T10:15:15.0,200.95000698237803,200.975006982378
2024-01-16T10:15:30.0,201.09273926971176,201.11773926971173
2024-01-16T10:15:45.0,201.18716724984458,201.21216724984455
2024-01-16T10:16:00.0,201.21781913381295,201.24281913381293
2024-01-16T10:16:15.0,201.25272920316596,201.27772920316593
2024-01-16T10:16:30.0,201.36928085333946,201.39428085333944
2024-01-16T10:16:45.0,201.3988603728207,201.42386037282068
2024-01-16T10:17:00.0,201.513275507282,201.53827550728198
2024-01-16T10:17:15.0,201.498360976157,201.52336097615697
2024-01-16T10:17:30.0,201.58228352133895,201.60728352133893
2024-01-16T10:17:45.0,201.5987742123382,201.6237742123382
2024-01-16T10:18:00.0,201.44272064298184,201.46772064298182
2024-01-16T10:18:15.0,201.62144057490275,201.64644057490273
2024-01-16T10:18:30.0,201.60267120868562,201.6276712086856
2024-01-16T10:18:45.0,201.63568591832674,201.66068591832672
2024-01-16T10:19:00.0,201.6763418385902,201.70134183859017
2024-01-16T10:19:15.0,201.63913068360273,201.6641306836027
2024-01-16T10:19:30.0,201.6886338547149,201.71363385471489
2024-01-16T10:19:45.0,201.80472500713483,201.8297250071348
2024-01-16T10:20:00.0,201.83430086159441,201.8593008615944
2024-01-16T10:20:15.0,201.85286874270895,201.87786874270893
2024-01-16T10:20:30.0,201.8136588934428,201.83865889344278
2024-01-16T10:20:45.0,201.88790212875065,201.91290212875063
2024-01-16T10:21:00.0,201.89748670636214,201.92248670636212
2024-01-16T10:21:15.0,201.91244678878292,201.9374467887829
2024-01-16T10:21:30.0,201.8483818768955,201.87338187689548
2024-01-16T10:21:45.0,201.961202067436,201.98620206743598
2024-01-16T10:22:00.0,202.0388229449684,202.06382294496836
2024-01-16T10:22:15.0,202.11421024274708,202.13921024274705
2024-01-16T10:22:30.0,202.2035533353314,202.22855333533138
2024-01-16T10:22:45.0,202.1586908099873,202.18369080998727
2024-01-16T10:23:00.0,202.03463913431662,202.0596391343166
2024-01-16T10:23:15.0,202.0282801390564,202.05328013905637
2024-01-16T10:23:30.0,202.03149877843913,202.0564987784391
2024-01-16T10:23:45.0,202.1328481563804,202.15784815638037
2024-01-16T10:24:00.0,202.16010143570747,202.18510143570745
2024-01-16T10:24:15.0,202.17561450215314,202.20061450215312
2024-01-16T10:24:30.0,202.30120395176365,202.32620395176363
2024-01-16T10:24:45.0,202.2330150647244,202.2580150647244
2024-01-16T10:25:00.0,202.05078201167413,202.0757820116741
2024-01-16T10:25:15.0,201.99138702280095,202.01638702280093
2024-01-16T10:25:30.0,202.0319076467355,202.05690764673548
2024-01-16T10:25:45.0,201.93503263053196,201.96003263053194
2024-01-16T10:26:00.0,201.98260802502588,202.00760802502586
2024-01-16T10:26:15.0,201.9598517488328,201.98485174883277
2024-01-16T10:26:30.0,201.7686907064877,201.79369070648767
2024-01-16T10:26:45.0,201.70488279779562,201.7298827977956
2024-01-16T10:27:00.0,201.69567625115548,201.72067625115545
2024-01-16T10:27:15.0,201.7630127634089,201.7880127634089
2024-01-16T10:27:30.0,201.80204608949253,201.8270460894925
2024-01-16T10:27:45.0,201.74224958581286,201.76724958581283
2024-01-16T10:28:00.0,201.8257019739295,201.8507019739295
2024-01-16T10:28:15.0,201.93091990271708,201.95591990271706
2024-01-16T10:28:30.0,201.88549813298343,201.9104981329834
2024-01-16T10:28:45.0,201.72085283155405,201.74585283155403
2024-01-16T10:29:00.0,201.7004078158071,201.72540781580707
2024-01-16T10:29:15.0,201.69401596510002,201.7190159651
2024-01-16T10:29:30.0,201.66441090538711,201.6894109053871
2024-01-16T10:29:45.0,201.5640523997331,201.58905239973308
2024-01-16T10:30:00.0,201.6471627923902,201.67216279239017
2024-01-16T10:30:15.0,201.6169329010248,201.64193290102477
2024-01-16T10:30:30.0,201.73561694242218,201.76061694242216
2024-01-16T10:30:45.0,201.82785821216123,201.8528582121612
2024-01-16T10:31:00.0,201.85067442106688,201.87567442106686
2024-01-16T10:31:15.0,201.87821511881177,201.90321511881174
2024-01-16T10:31:30.0,201.800983609789,201.82598360978898
2024-01-16T10:31:45.0,201.66282227747857,201.68782227747855
2024-01-16T10:32:00.0,201.6982816933417,201.72328169334168
2024-01-16T10:32:15.0,201.65882120868162,201.6838212086816
2024-01-16T10:32:30.0,201.7312291491142,201.75622914911418
2024-01-16T10:32:45.0,201.7507202497825,201.77572024978247
2024-01-16T10:33:00.0,201.6665387137817,201.69153871378168
2024-01-16T10:33:15.0,201.59944769447443,201.6244476944744
2024-01-16T10:33:30.0,201.6631056875562,201.68810568755617
2024-01-16T10:33:45.0,201.70246584956314,201.72746584956312
2024-01-16T10:34:00.0,201.68140884638856,201.70640884638854
2024-01-16T10:34:15.0,201.6308573050247,201.65585730502468
2024-01-16T10:34:30.0,201.55358745750715,201.57858745750713
2024-01-16T10:34:45.0,201.65073639817925,201.67573639817923
2024-01-16T10:35:00.0,201.77945723958757,201.80445723958755
2024-01-16T10:35:15.0,201.81969098960613,201.8446909896061
2024-01-16T10:35:30.0,201.76781155086368,201.79281155086366
2024-01-16T10:35:45.0,201.84588841817975,201.87088841817973
2024-01-16T10:36:00.0,201.57921573580848,201.60421573580845
2024-01-16T10:36:15.0,201.59160701905472,201.6166070190547
2024-01-16T10:36:30.0,201.44395285184504,201.46895285184502
2024-01-16T10:36:45.0,201.4550107133538,201.48001071335378
2024-01-16T10:37:00.0,201.5568669694609,201.5818669694609
2024-01-16T10:37:15.0,201.4029664946298,201.42796649462977
2024-01-16T10:37:30.0,201.37972812659376,201.40472812659374
2024-01-16T10:37:45.0,201.35452377008966,201.37952377008963
2024-01-16T10:38:00.0,201.44348403507294,201.46848403507292
2024-01-16T10:38:15.0,201.48293214772968,201.50793214772966
2024-01-16T10:38:30.0,201.4510312490278,201.47603124902778
2024-01-16T10:38:45.0,201.34561108340026,201.37061108340023
2024-01-16T10:39:00.0,201.42187713983685,201.44687713983683
2024-01-16T10:39:15.0,201.40784063212584,201.43284063212582
2024-01-16T10:39:30.0,201.37249075054967,201.39749075054965
2024-01-16T10:39:45.0,201.410632737897,201.43563273789698
2024-01-16T10:40:00.0,201.39482902172364,201.41982902172361
2024-01-16T10:40:15.0,201.37047924010028,201.39547924010026
2024-01-16T10:40:30.0,201.397461595886,201.42246159588598
2024-01-16T10:40:45.0,201.33668263727924,201.36168263727922
2024-01-16T10:41:00.0,201.35557516957167,201.38057516957164
2024-01-16T10:41:15.0,201.31634272944257,201.34134272944254
2024-01-16T10:41:30.0,201.37468635637424,201.39968635637422
2024-01-16T10:41:45.0,201.3915397496744,201.41653974967437
2024-01-16T10:42:00.0,201.4016157799652,201.42661577996518
2024-01-16T10:42:15.0,201.4061675233233,201.43116752332327
2024-01-16T10:42:30.0,201.37089915312416,201.39589915312413
2024-01-16T10:42:45.0,201.4772005791741,201.5022005791741
2024-01-16T10:43:00.0,201.53933568527242,201.5643356852724
2024-01-16T10:43:15.0,201.58729960853663,201.6122996085366
2024-01-16T10:43:30.0,201.5427047486397,201.56770474863967
2024-01-16T10:43:45.0,201.63163474846812,201.6566347484681
2024-01-16T10:44:00.0,201.60451870953702,201.629518709537
2024-01-16T10:44:15.0,201.61360607862454,201.63860607862452
2024-01-16T10:44:30.0,201.55816288443614,201.58316288443612
2024-01-16T10:44:45.0,201.58335023267898,201.60835023267896
2024-01-16T10:45:00.0,201.62920034950142,201.6542003495014
2024-01-16T10:45:15.0,201.54995806994418,201.57495806994416
2024-01-16T10:45:30.0,201.65695067635468,201.68195067635466
2024-01-16T10:45:45.0,201.7658967930407,201.79089679304067
2024-01-16T10:46:00.0,201.76634731482636,201.79134731482634
2024-01-16T10:46:15.0,201.82767726793836,201.85267726793833
2024-01-16T10:46:30.0,201.7310225517113,201.75602255171128
2024-01-16T10:46:45.0,201.76321090617324,201.78821090617322
2024-01-16T10:47:00.0,201.74324298196512,201.7682429819651
2024-01-16T10:47:15.0,201.7838935114365,201.80889351143648
2024-01-16T10:47:30.0,201.7226730920551,201.74767309205507
2024-01-16T10:47:45.0,201.7299682190741,201.75496821907407
2024-01-16T10:48:00.0,201.58891481739045,201.61391481739042
2024-01-16T10:48:15.0,201.56314186376608,201.58814186376605
2024-01-16T10:48:30.0,201.7456893189009,201.77068931890088
2024-01-16T10:48:45.0,201.7385783641292,201.7635783641292
2024-01-16T10:49:00.0,201.78185857163677,201.80685857163675
2024-01-16T10:49:15.0,201.81528499772205,201.84028499772202
2024-01-16T10:49:30.0,201.84730632486117,201.87230632486114
2024-01-16T10:49:45.0,201.89648559208447,201.92148559208445
2024-01-16T10:50:00.0,201.94345794579118,201.96845794579116
2024-01-16T10:50:15.0,201.80590271276287,201.83090271276285
2024-01-16T10:50:30.0,201.74583630108282,201.7708363010828
2024-01-16T10:50:45.0,201.7152642941003,201.74026429410029
2024-01-16T10:51:00.0,201.75034987488746,201.77534987488744
2024-01-16T10:51:15.0,201.81303578060795,201.83803578060792
2024-01-16T10:51:30.0,201.78441877998026,201.80941877998023
2024-01-16T10:51:45.0,201.85790258736677,201.88290258736674
2024-01-16T10:52:00.0,201.9181033444103,201.94310334441028
2024-01-16T10:52:15.0,201.82614921110164,201.8511492111016
2024-01-16T10:52:30.0,201.84764151227793,201.8726415122779
2024-01-16T10:52:45.0,201.85763109962255,201.88263109962253
2024-01-16T10:53:00.0,201.82901949142982,201.8540194914298
2024-01-16T10:53:15.0,201.85795410252913,201.8829541025291
2024-01-16T10:53:30.0,201.87330924496888,201.89830924496886
2024-01-16T10:53:45.0,201.98700405710198,202.01200405710196
2024-01-16T10:54:00.0,202.21968111486896,202.24468111486894
2024-01-16T10:54:15.0,202.15892716235913,202.1839271623591
2024-01-16T10:54:30.0,202.20619346804162,202.2311934680416
2024-01-16T10:54:45.0,202.26809276229005,202.29309276229003
2024-01-16T10:55:00.0,202.26374175613068,202.28874175613066
2024-01-16T10:55:15.0,202.39851743906817,202.42351743906815
2024-01-16T10:55:30.0,202.52718804454082,202.5521880445408
2024-01-16T10:55:45.0,202.53377059679977,202.55877059679975
2024-01-16T10:56:00.0,202.45841235960896,202.48341235960893
2024-01-16T10:56:15.0,202.44816316097143,202.4731631609714
2024-01-16T10:56:30.0,202.53782103626693,202.5628210362669
2024-01-16T10:56:45.0,202.47910110110703,202.504101101107
2024-01-16T10:57:00.0,202.53636325577108,202.56136325577106
2024-01-16T10:57:15.0,202.51110487523223,202.5361048752322
2024-01-16T10:57:30.0,202.58316040599675,202.60816040599673
2024-01-16T10:57:45.0,202.60572446725536,202.63072446725533
2024-01-16T10:58:00.0,202.57503563457092,202.6000356345709
2024-01-16T10:58:15.0,202.6361757318654,202.66117573186537
2024-01-16T10:58:30.0,202.82060277044775,202.84560277044773
2024-01-16T10:58:45.0,202.82732945077157,202.85232945077155
2024-01-16T10:59:00.0,202.66828953060028,202.69328953060025
2024-01-16T10:59:15.0,202.48087289417347,202.50587289417345
2024-01-16T10:59:30.0,202.50235216452424,202.52735216452422
2024-01-16T10:59:45.0,202.44707832949973,202.4720783294997
2024-01-16T11:00:00.0,202.3978440272464,202.42284402724638

</script>

<!-- ACTUAL CONTENT -->

<h1>Execution Markout Examples</h1>
<p></p>

<div style="padding: 20px;">
    <h2>Example 1: Multi-Venue Buy Execution</h2>
    <p>Analyzing a large buy order (10,000 shares) executed across multiple venues. The implementation shortfall shows cost vs arrival price. VWAP shortfall shows performance vs execution VWAP. Spread crossing percentage indicates how aggressive fills were (0%=bid, 100%=ask). Click fills to exclude from analysis. Hover over table rows to highlight corresponding chart points.</p>

    <div style="margin: 20px 0;">
        <label for="execution_select_example1_exec">Execution: </label>
        <select id="execution_select_example1_exec" onchange="updateChart_example1_exec()">
                    <option value="Execution_1" selected>Execution_1</option>
        </select>

        <label for="benchmark_select_example1_exec" style="margin-left: 20px;">Benchmark: </label>
        <select id="benchmark_select_example1_exec" onchange="updateChart_example1_exec()">
        <option value="arrival" selected>Arrival</option>
        <option value="first">First Fill Mid</option>
        </select>

        <label style="margin-left: 20px;">
            <input type="checkbox" id="show_volume_checkbox_example1_exec" checked onchange="updateChart_example1_exec()">
            Show Volume
        </label>
    </div>

    <div id="example1_exec" style="width: 100%; height: 800px;"></div>

    <div style="display: flex; margin-top: 20px;">
        <div id="fills_table_example1_exec" style="flex: 1; margin-right: 20px;"></div>
        <div id="summary_table_example1_exec" style="flex: 1;"></div>
    </div>
</div>
<br>
<hr>
<br>
<div style="padding: 20px;">
    <h2>Example 2: Algorithmic Sell Execution (No Arrival Price)</h2>
    <p>Selling 15,000 shares using multiple algorithmic strategies. Since no arrival price is provided, the benchmark defaults to the mid price at the first fill. This is common when analyzing post-trade execution quality. The spread crossing shows how close to the bid (neartouch for sells) each fill was.</p>

    <div style="margin: 20px 0;">
        <label for="execution_select_example2_exec">Execution: </label>
        <select id="execution_select_example2_exec" onchange="updateChart_example2_exec()">
                    <option value="Execution_2" selected>Execution_2</option>
        </select>

        <label for="benchmark_select_example2_exec" style="margin-left: 20px;">Benchmark: </label>
        <select id="benchmark_select_example2_exec" onchange="updateChart_example2_exec()">
        <option value="first" selected>First Fill Mid</option>
        </select>

        <label style="margin-left: 20px;">
            <input type="checkbox" id="show_volume_checkbox_example2_exec" checked onchange="updateChart_example2_exec()">
            Show Volume
        </label>
    </div>

    <div id="example2_exec" style="width: 100%; height: 800px;"></div>

    <div style="display: flex; margin-top: 20px;">
        <div id="fills_table_example2_exec" style="flex: 1; margin-right: 20px;"></div>
        <div id="summary_table_example2_exec" style="flex: 1;"></div>
    </div>
</div>
<br>
<hr>
<br>
<div style="padding: 20px;">
    <h2>Example 3: Comparing Aggressive vs Patient Execution</h2>
    <p>Compare two different execution strategies for buying the same stock. The aggressive execution (high urgency) completes faster but may have higher implementation shortfall. The patient execution takes longer but aims for better prices. Use the execution selector to switch between them and compare their performance metrics.</p>

    <div style="margin: 20px 0;">
        <label for="execution_select_example3_exec">Execution: </label>
        <select id="execution_select_example3_exec" onchange="updateChart_example3_exec()">
                    <option value="Aggressive_Buy" selected>Aggressive_Buy</option>
                    <option value="Patient_Buy">Patient_Buy</option>
        </select>

        <label for="benchmark_select_example3_exec" style="margin-left: 20px;">Benchmark: </label>
        <select id="benchmark_select_example3_exec" onchange="updateChart_example3_exec()">
        <option value="arrival" selected>Arrival</option>
        <option value="first">First Fill Mid</option>
        </select>

        <label style="margin-left: 20px;">
            <input type="checkbox" id="show_volume_checkbox_example3_exec" checked onchange="updateChart_example3_exec()">
            Show Volume
        </label>
    </div>

    <div id="example3_exec" style="width: 100%; height: 800px;"></div>

    <div style="display: flex; margin-top: 20px;">
        <div id="fills_table_example3_exec" style="flex: 1; margin-right: 20px;"></div>
        <div id="summary_table_example3_exec" style="flex: 1;"></div>
    </div>
</div>


<hr><p align="right"><small>This page was created using <a href="https://github.com/s-baumann/JSPlots.jl">JSPlots.jl</a> v0.4.0.</small></p>
</body>
</html>
